<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Link Roblox</title>
</head>
<body>
    Give us a moment...
</body>
<script>
    window.onload = () => {
        function getCookie(name) {
            let value = `; ${document.cookie}`;
            let parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
        }
        const loggedin = getCookie('discord')
        if (loggedin) {
            fetch('https://discord.com/api/users/@me', {
                headers: {
                    authorization: `Bearer ${loggedin}`,
                },
            })
            .then(result => result.json())
            .then(response => {
                const params = new URLSearchParams(window.location.search)
                const authcode = params.get("code")

                if (authcode) {
                    const request_body = "grant_type=authorization_code&code=" + authcode + "&client_id=8552523254541415001&client_secret=RBX-IG6s_w4dUUeozQyCmz2IuZOMjhSv3uwGRR_mazvohPAWlDLTigHSy25YpiSgeQCI"
                    console.log("Exchanging code...")
                    document.body.innerHTML = "Exchanging code..."
                    fetch("https://apis.roblox.com/oauth/v1/token", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/x-www-form-urlencoded"
                        },
                        body: request_body
                    })
                    .then(result => result.json())
                    .then(response => {
                        if (response.error) {
                            document.body.innerHTML = "Failed to exchange code: " + response.error_description
                        } else if (response.access_token) {
                            document.body.innerHTML = "Exchanged: " + response.access_token
                        } else {
                            document.body.innerHTML = "An unknown error occured. Please try again later."
                        }
                    })
                } else {
                    const id = response.id
                    fetch('https://glowworm-learning-leech.ngrok-free.app/getlink', {
                        method: "GET",
                        headers: {
                            "ngrok-skip-browser-warning": "69420",
                            "discord-id": id
                        }
                    })
                    .then(result => result.json())
                    .then(response => {
                        const link = response.link

                        if (link) {
                            document.body.innerHTML = "You're currently linked with " + link.robloxUser.name + "."
                        } else {
                            document.body.innerHTML = "You're not linked with a Roblox user.<br><br>Redirecting you to Roblox..."
                            window.location.href = "https://authorize.roblox.com/?client_id=8552523254541415001&response_type=code&redirect_uri=https%3A%2F%2Fduckybot.xyz%2Flink&scope=openid"
                        }
                    })
                    .catch(console.error)
                }
            })
            .catch(console.error)

            return
        } else {
            document.body.innerHTML = "You're not logged in.<br><br>Redirecting you to the login page...<br>You'll automatically be redirected back here."
            window.location.href = "https://duckybot.xyz/login?redirect=link"
            return
        }
    }
</script>
</html>