<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="Ducky Moderation Panel - Manage your ER:LC server">
    <meta content="Ducky ・ Moderation Panel" property="og:title">
    <meta content="Manage your ER:LC server with Ducky's powerful moderation tools" property="og:description">
    <meta content="https://duckybot.xyz/modpanel" property="og:url">
    <meta content="https://duckybot.xyz/images/Ducky.svg" property="og:image">
    <meta content="#F5FF82" name="theme-color">
    <link rel="icon" href="https://duckybot.xyz/images/Ducky.svg">
    <title>Ducky ・ Moderation Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary: #F5FF82;
            --primary-dark: #e6ff4d;
            --background: #0a0a0a;
            --card-bg: #121212;
            --card-border: rgba(255, 255, 255, 0.1);
            --card-hover-border: rgba(245, 255, 130, 0.3);
            --text: #ffffff;
            --text-secondary: #9ca3af;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background);
            color: var(--text);
            -webkit-tap-highlight-color: transparent;
        }
        
        .grid-container {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            gap: 1rem;
            width: 100%;
        }
        
        .grid-item {
            background-color: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 8px;
            transition: border-color 0.2s ease;
            overflow: hidden;
        }
        
        .grid-item:hover {
            border-color: var(--card-hover-border);
        }
        
        .grid-item-header {
            padding: 1rem;
            border-bottom: 1px solid var(--card-border);
            font-weight: 600;
        }
        
        .grid-item-content {
            padding: 1rem;
        }
        
        .col-span-12 {
            grid-column: span 12;
        }
        
        .col-span-8 {
            grid-column: span 8;
        }
        
        .col-span-6 {
            grid-column: span 6;
        }
        
        .col-span-4 {
            grid-column: span 4;
        }
        
        @media (max-width: 1024px) {
            .lg\:col-span-6 {
                grid-column: span 12;
            }
            .lg\:col-span-4 {
                grid-column: span 6;
            }
            .lg\:col-span-8 {
                grid-column: span 12;
            }
        }
        
        @media (max-width: 768px) {
            .md\:col-span-6,
            .lg\:col-span-4 {
                grid-column: span 12;
            }
            .grid-container {
                gap: 0.75rem;
            }
        }
        
        .glow {
            position: absolute;
            width: 100%;
            height: 300px;
            border-radius: 50%;
            filter: blur(120px);
            opacity: 0.05;
            z-index: -1;
            pointer-events: none;
        }
        
        .mobile-menu {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 40;
            opacity: 0;
            transform: translateY(-100%);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        
        .mobile-menu.active {
            display: flex;
            opacity: 1;
            transform: translateY(0);
        }
        
        .server-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 1rem;
        }
        
        .server-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            padding: 1rem;
            cursor: pointer;
            background-color: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 8px;
            transition: border-color 0.2s ease;
        }
        
        .server-card:hover {
            border-color: var(--card-hover-border);
        }
        
        .server-card img {
            width: 3rem;
            height: 3rem;
            border-radius: 50%;
            object-fit: cover;
        }
        
        .tab-button {
            position: relative;
            transition: all 0.2s ease;
            padding: 0.5rem 1rem;
            background: transparent;
            border: none;
            cursor: pointer;
            font-weight: 500;
            color: var(--text-secondary);
        }
        
        .tab-button.active {
            color: var(--primary);
        }
        
        .tab-button.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 100%;
            height: 2px;
            background-color: var(--primary);
        }
        
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 1rem;
            border-radius: 8px;
            z-index: 100;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s ease;
        }
        
        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }
        
        .toast.success {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
            border: 1px solid rgba(16, 185, 129, 0.3);
        }
        
        .toast.error {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
            border: 1px solid rgba(239, 68, 68, 0.3);
        }
        
        .spinner {
            width: 1.5rem;
            height: 1.5rem;
            border: 2px solid rgba(245, 255, 130, 0.2);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; visibility: hidden; }
        }
        
        .fade-out {
            animation: fadeOut 0.5s forwards;
        }
        
        .punishment-item {
            position: relative;
            padding: 1rem;
            border-radius: 0;
            background-color: rgba(18, 18, 18, 0.8);
            border-left: 3px solid #e74c3c; 
            margin-bottom: 0.5rem;
            transition: background-color 0.2s ease;
        }

        .punishment-item:hover {
            background-color: rgba(30, 30, 30, 0.8);
        }

        .punishment-item .user-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .punishment-item .punishment-type {
            font-weight: 500;
        }

        .punishment-item .punishment-reason {
            word-break: break-word;
        }

        .punishment-item .meta-info {
            text-align: right;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 0.5rem;
        }
        
        .delete-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: rgba(239, 68, 68, 0.1);
            color: var(--danger);
            width: 2rem;
            height: 2rem;
            border-radius: 50%;
            transition: all 0.2s ease;
            cursor: pointer;
            opacity: 0;
            position: absolute;
            bottom: 0.75rem;
            right: 0.75rem;
        }

        .punishment-item:hover .delete-btn {
            opacity: 1;
        }
        
        .shift-controls {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }
        
        .shift-btn {
            flex: 1;
            padding: 0.75rem;
            border-radius: 6px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            transition: all 0.2s ease;
            cursor: pointer;
            border: none;
        }
        
        .shift-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .shift-btn-start {
            background-color: var(--success);
            color: white;
        }
        
        .shift-btn-start:hover:not(:disabled) {
            background-color: #059669;
        }
        
        .shift-btn-pause {
            background-color: var(--warning);
            color: white;
        }
        
        .shift-btn-pause:hover:not(:disabled) {
            background-color: #d97706;
        }
        
        .shift-btn-end {
            background-color: var(--danger);
            color: white;
        }
        
        .shift-btn-end:hover:not(:disabled) {
            background-color: #dc2626;
        }
        
        .confirmation-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .confirmation-modal.active {
            opacity: 1;
            visibility: visible;
        }
        
        .modal-content {
            background-color: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 12px;
            padding: 1.5rem;
            width: 90%;
            max-width: 400px;
            transform: translateY(-20px);
            transition: all 0.3s ease;
        }
        
        .confirmation-modal.active .modal-content {
            transform: translateY(0);
        }
        
        .modal-actions {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
        }
        
        .shift-status {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 600;
        }
        
        .shift-status.active {
            background-color: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }
        
        .shift-status.paused {
            background-color: rgba(245, 158, 11, 0.1);
            color: var(--warning);
        }
        
        .shift-status.inactive {
            background-color: rgba(156, 163, 175, 0.1);
            color: var(--text-secondary);
        }
        
        .pulse {
            width: 0.5rem;
            height: 0.5rem;
            border-radius: 50%;
        }
        
        .pulse.active {
            background-color: var(--success);
            animation: pulse 2s infinite;
        }
        
        .pulse.paused {
            background-color: var(--warning);
            animation: pulse-paused 2s infinite;
        }
        
        .pulse.inactive {
            animation: none;
            background-color: var(--text-secondary);
        }
        
        @keyframes pulse {
            0% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7);
            }
            
            70% {
                transform: scale(1);
                box-shadow: 0 0 0 10px rgba(16, 185, 129, 0);
            }
            
            100% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0);
            }
        }
        
        @keyframes pulse-paused {
            0% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.7);
            }
            
            70% {
                transform: scale(1);
                box-shadow: 0 0 0 10px rgba(245, 158, 11, 0);
            }
            
            100% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(245, 158, 11, 0);
            }
        }
        
        .avatar-circle {
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 50%;
            overflow: hidden;
            background-color: #2d2d2d;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: var(--primary);
        }
        
        .avatar-circle img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .shift-card {
            display: flex;
            gap: 1rem;
            padding: 1rem;
            border-radius: 8px;
            background-color: rgba(30, 30, 30, 0.5);
            border: 1px solid var(--card-border);
            transition: all 0.2s ease;
            margin-bottom: 0.75rem;
        }
        
        .shift-card:hover {
            border-color: var(--card-hover-border);
            background-color: rgba(30, 30, 30, 0.7);
        }
        
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 3rem;
            text-align: center;
            color: var(--text-secondary);
        }
        
        .empty-state i {
            font-size: 3rem;
            margin-bottom: 1rem;
            color: #4b5563;
        }
        
        .custom-dropdown {
            position: relative;
            width: 100%;
        }
        
        .dropdown-selected {
            width: 100%;
            padding: 0.5rem 1rem;
            background-color: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--card-border);
            border-radius: 0.375rem;
            color: white;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s ease;
        }
        
        .dropdown-selected:hover {
            border-color: var(--card-hover-border);
        }
        
        .dropdown-selected.active {
            border-color: var(--primary);
        }
        
        .dropdown-selected span {
            margin-right: 1rem; 
        }
        
        .dropdown-options {
            position: absolute;
            top: calc(100% + 0.25rem);
            left: 0;
            right: 0;
            background-color: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 0.375rem;
            max-height: 0;
            overflow: hidden;
            opacity: 0;
            transition: all 0.2s ease;
            z-index: 10;
        }
        
        .dropdown-options.active {
            max-height: 200px;
            opacity: 1;
            overflow-y: auto;
        }
        
        .dropdown-option {
            padding: 0.5rem 1rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .dropdown-option:hover {
            background-color: rgba(245, 255, 130, 0.1);
        }
        
        .dropdown-option.selected {
            background-color: rgba(245, 255, 130, 0.2);
            color: var(--primary);
        }
        
        @media (max-width: 768px) {
            .server-grid {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            }
        }

        .punishment-list {
            max-height: 600px;
            overflow-y: auto;
            padding-right: 0.5rem;
        }

        .bolo-tag {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            background-color: rgba(239, 68, 68, 0.1);
            color: var(--danger);
        }

        .bolo-tag i {
            margin-right: 0.25rem;
        }
        
        .server-info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }
        
        .server-info-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }
        
        .server-info-label {
            color: var(--text-secondary);
            min-width: 120px;
        }
        
        .server-info-value {
            font-weight: 500;
        }
        
        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .status-badge.online {
            background-color: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }
        
        .status-badge.offline {
            background-color: rgba(239, 68, 68, 0.1);
            color: var(--danger);
        }
        
        .team-stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
        
        .team-stat-item {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }
        
        .team-stat-label {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }
        
        .team-stat-value {
            font-size: 1.5rem;
            font-weight: 600;
        }
        
        .last-updated {
            margin-top: 1rem;
            color: var(--text-secondary);
            font-size: 0.875rem;
            text-align: right;
        }
        
        .input-field {
            width: 100%;
            padding: 0.5rem 0.75rem;
            background-color: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--card-border);
            border-radius: 0.375rem;
            color: white;
            transition: all 0.2s ease;
        }
        
        .input-field:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(245, 255, 130, 0.1);
        }
        
        .input-label {
            display: block;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-secondary);
        }
        
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-weight: 500;
            transition: all 0.2s ease;
            cursor: pointer;
            border: none;
        }
        
        .btn-primary {
            background-color: var(--primary);
            color: black;
        }
        
        .btn-primary:hover {
            background-color: var(--primary-dark);
        }
        
        .btn-secondary {
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
        }
        
        .btn-secondary:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }
        
        .btn-danger {
            background-color: var(--danger);
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #dc2626;
        }
        
        .btn-success {
            background-color: var(--success);
            color: white;
        }
        
        .btn-success:hover {
            background-color: #059669;
        }
        
        .moderation-log {
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        
        .moderation-log-header {
            display: grid;
            grid-template-columns: 2fr 1fr 2fr 1fr;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--card-border);
            font-weight: 600;
            color: var(--text-secondary);
        }
        
        .moderation-log-content {
            flex: 1;
            overflow-y: auto;
            padding: 0.5rem;
        }
        
        .active-staff-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            border-radius: 6px;
            background-color: rgba(18, 18, 18, 0.6);
            margin-bottom: 0.5rem;
        }
        
        .staff-info {
            flex: 1;
        }
        
        .staff-name {
            font-weight: 500;
        }
        
        .staff-status {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }
        
        .staff-active-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            background-color: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }
        
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #1e1e1e;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        
        @media (max-width: 640px) {
            .grid-container {
                grid-template-columns: 1fr;
            }
            
            .col-span-6, .col-span-8, .col-span-4 {
                grid-column: span 1;
            }
        }

        @media (max-width: 768px) {
            .moderation-log-header {
                display: none;
            }
            
            .punishment-item {
                display: block;
                padding-bottom: 2.5rem;
            }
            
            .punishment-item .user-info {
                margin-bottom: 0.75rem;
            }
            
            .punishment-item .punishment-type {
                margin-bottom: 0.5rem;
            }
            
            .punishment-item .punishment-reason {
                margin-bottom: 0.75rem;
            }
            
            .punishment-item .meta-info {
                align-items: flex-start;
                margin-top: 0.5rem;
            }
            
            .delete-btn {
                bottom: 0.75rem;
                right: 0.75rem;
                opacity: 1;
            }
        }

.flex.gap-4.mb-4.border-b.border-white\/10.pb-2 {
  overflow-x: auto;
  white-space: nowrap;
  -webkit-overflow-scrolling: touch;
  scrollbar-width: none; 
  padding-bottom: 0.5rem;
}

.flex.gap-4.mb-4.border-b.border-white\/10.pb-2::-webkit-scrollbar {
  display: none;
}

.punishment-item {
  position: relative;
  padding: 1rem;
  border-radius: 0;
  background-color: rgba(18, 18, 18, 0.8);
  border-left: 3px solid #e74c3c; 
  margin-bottom: 0.5rem;
  transition: background-color 0.2s ease;
}

@media (max-width: 768px) {
  .server-info-grid {
    grid-template-columns: 1fr;
  }
  
  .grid-container .col-span-8,
  .grid-container .col-span-4 {
    grid-column: span 12;
  }
}

.moderation-log-header {
  display: grid;
  grid-template-columns: 2fr 1fr 2fr 1fr;
  padding: 0.75rem 1rem;
  border-bottom: 1px solid var(--card-border);
  font-weight: 600;
  color: var(--text-secondary);
}

.punishment-item {
  display: grid;
  grid-template-columns: 2fr 1fr 2fr 1fr;
  align-items: center;
}

.punishment-item .user-info {
  display: flex;
  align-items: center;
  gap: 0.75rem;
}

.punishment-item .punishment-type {
  font-weight: 500;
}

.punishment-item .punishment-reason {
  word-break: break-word;
}

.punishment-item .meta-info {
  text-align: right;
}

.delete-btn {
  position: absolute;
  bottom: 0.75rem;
  right: 0.75rem;
  opacity: 0;
}

@media (max-width: 768px) {
  .moderation-log-header {
    display: none;
  }
  
  .punishment-item {
    display: block;
    padding-bottom: 2.5rem;
  }
  
  .punishment-item .user-info {
    margin-bottom: 0.75rem;
  }
  
  .punishment-item .punishment-type {
    margin-bottom: 0.5rem;
  }
  
  .punishment-item .punishment-reason {
    margin-bottom: 0.75rem;
  }
  
  .punishment-item .meta-info {
    align-items: flex-start;
    margin-top: 0.5rem;
  }
  
  .delete-btn {
    opacity: 1;
  }
}

    .scrollbar-hide::-webkit-scrollbar {
        display: none;
    }
    .scrollbar-hide {
        -ms-overflow-style: none;
        scrollbar-width: none;
    }
    
    @media (max-width: 768px) {
        .server-info-grid {
            grid-template-columns: 1fr;
            gap: 1rem;
        }
        
        .server-info-item {
            flex-direction: column;
            align-items: flex-start;
            gap: 0.25rem;
        }
        
        .server-info-label {
            min-width: auto;
        }
        
        #erlcPlayersList {
            grid-template-columns: 1fr;
        }
        
        #discordCheckList {
            grid-template-columns: 1fr;
        }
    }
    
    .punishment-item {
        position: relative;
        padding: 1rem;
        border-radius: 4px;
        background-color: rgba(18, 18, 18, 0.8);
        border-left: 3px solid #e74c3c;
        margin-bottom: 0.5rem;
        transition: background-color 0.2s ease;
    }
    
    .punishment-item:hover {
        background-color: rgba(30, 30, 30, 0.9);
    }
    
    .delete-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: rgba(239, 68, 68, 0.1);
        color: var(--danger);
        width: 2rem;
        height: 2rem;
        border-radius: 50%;
        transition: all 0.2s ease;
        cursor: pointer;
        position: absolute;
        bottom: 0.75rem;
        right: 0.75rem;
        opacity: 0;
    }
    
    .punishment-item:hover .delete-btn {
        opacity: 1;
    }
    
    @media (max-width: 768px) {
        .delete-btn {
            opacity: 1;
        }
    }

    @media (max-width: 640px) {
        .grid-container {
            gap: 0.5rem;
        }
        
        .grid-item {
            margin-bottom: 0.5rem;
        }
        
        .grid-item-header {
            padding: 0.75rem;
        }
        
        .grid-item-content {
            padding: 0.75rem;
        }
        
        .btn {
            width: 100%;
        }
        
        .server-info-item {
            margin-bottom: 0.5rem;
        }
    }
</style>
</head>
<body>
    <div class="glow bg-[#F5FF82] top-0 left-0"></div>
    <div class="glow bg-[#F5FF82] bottom-0 right-0"></div>

    <div id="loadingOverlay" class="fixed inset-0 bg-black/80 flex items-center justify-center z-50">
        <div class="flex flex-col items-center">
            <div class="w-12 h-12 border-4 border-[#F5FF82]/20 border-t-[#F5FF82] rounded-full animate-spin mb-4"></div>
            <p class="text-gray-400">Loading...</p>
        </div>
    </div>

    <nav class="sticky top-0 z-50 backdrop-blur-sm border-b border-white/5 bg-[#0f0f0f]/30">
        <div class="max-w-7xl mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <a href="/" class="flex items-center gap-3">
                    <img src="https://duckybot.xyz/images/Ducky.svg" alt="Ducky" class="w-8 h-8">
                    <span class="text-2xl font-bold text-[#F5FF82]">Ducky</span>
                </a>
                <div class="hidden md:flex items-center gap-6">
                    <a href="/team" class="text-gray-300 hover:text-[#F5FF82] transition">Team</a>
                    <a href="/docs" class="text-gray-300 hover:text-[#F5FF82] transition">Docs</a>
                    <a href="/invite" class="text-gray-300 hover:text-[#F5FF82] transition">Invite</a>
                    <a href="/status" class="text-gray-300 hover:text-[#F5FF82] transition">Status</a>
                    <a href="/support" class="text-gray-300 hover:text-[#F5FF82] transition">Support</a>
                    <a href="/plus"
                        class="px-4 py-2 bg-[#F5FF82] text-[#12131a] rounded-lg font-medium hover:opacity-90 transition">
                        Get Ducky Plus+
                    </a>
                </div>
                <button id="menuBtn" class="md:hidden text-2xl text-[#F5FF82] hover:opacity-80 transition">
                    <i class="fas fa-bars"></i>
                </button>
            </div>
        </div>
    </nav>

    <div id="mobileMenu" class="mobile-menu flex-col items-center justify-center gap-8">
        <button class="absolute top-6 right-6 text-2xl" id="closeMenuBtn">
            <i class="fas fa-times"></i>
        </button>
        <a href="/team" class="text-xl text-gray-300 hover:text-[#F5FF82] transition">Team</a>
        <a href="/docs" class="text-xl text-gray-300 hover:text-[#F5FF82] transition">Docs</a>
        <a href="/invite" class="text-xl text-gray-300 hover:text-[#F5FF82] transition">Invite</a>
        <a href="/status" class="text-xl text-gray-300 hover:text-[#F5FF82] transition">Status</a>
        <a href="/support" class="text-xl text-gray-300 hover:text-[#F5FF82] transition">Support</a>
        <a href="/plus" class="px-6 py-3 bg-[#F5FF82] text-[#12131a] rounded-lg font-medium hover:opacity-90 transition">
            Get Ducky Plus+
        </a>
    </div>

    <main class="max-w-7xl mx-auto px-4 py-8">
        <div id="serverSelectionView" class="mt-4 opacity-0 transition-opacity duration-500">
            <div class="grid-item p-4 mb-6 flex items-center gap-3">
                <img id="profilePicture" alt="Profile" class="w-12 h-12 rounded-full">
                <div>
                    <h2 class="text-lg font-bold">Welcome, <span id="username" class="text-[#F5FF82]"></span></h2>
                    <p class="text-gray-400 mt-0.5 text-sm">Select a server to moderate</p>
                </div>
            </div>

            <div class="grid-item p-4">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4">
                    <h2 class="text-lg font-bold">Your Servers</h2>
                    <span class="text-sm text-gray-400">Only servers with Ducky and moderation permissions are shown</span>
                </div>
                <div id="serverGrid" class="server-grid p-2">
                    <div class="col-span-full text-center py-4">
                        <div class="spinner mx-auto mb-2"></div>
                        <p class="text-gray-400">Loading servers...</p>
                    </div>
                </div>
            </div>
        </div>

        <div id="moderationPanelView" class="hidden mt-4">
            <div class="grid-item p-4 mb-6 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <img id="serverIcon" alt="Server Icon" class="w-12 h-12 rounded-full">
                    <div>
                        <h2 class="text-lg font-bold"><span id="serverName" class="text-[#F5FF82]"></span></h2>
                        <p class="text-gray-400 mt-0.5 text-sm">Moderation Panel</p>
                    </div>
                </div>
                <button id="backToServersBtn" class="btn btn-secondary">
                    <i class="fas fa-arrow-left mr-2"></i>Back
                </button>
            </div>

            <div class="flex gap-4 mb-4 border-b border-white/10 pb-2 overflow-x-auto whitespace-nowrap scrollbar-hide">
    <button id="punishmentsTabBtn" class="tab-button active flex-shrink-0">Punishments</button>
    <button id="shiftsTabBtn" class="tab-button flex-shrink-0">Shifts</button>
    <button id="erlcTabBtn" class="tab-button flex-shrink-0">ER:LC Integration</button>
    <button id="automationsTabBtn" class="tab-button flex-shrink-0">Automations</button>
</div>

            <div id="punishmentsTab">
                <div class="grid-container">
                    <div class="col-span-6 lg:col-span-6">
                        <div class="grid-item mb-6">
                            <div class="grid-item-header">
                                <h3>Moderation</h3>
                                <p class="text-sm text-gray-400 mt-1">Log moderations for ROBLOX users.</p>
                            </div>
                            <div class="grid-item-content">
                                <form id="punishmentForm" class="space-y-4">
                                    <div>
                                        <label for="robloxUsername" class="input-label">Roblox Username</label>
                                        <input type="text" id="robloxUsername" class="input-field" placeholder="Enter username" required>
                                    </div>
                                    <div>
                                        <label for="punishmentTypeContainer" class="input-label">Punishment Type</label>
                                        <div id="punishmentTypeContainer" class="custom-dropdown">
                                            <div class="dropdown-selected" id="punishmentTypeSelected">
                                                <span>Select type...</span>
                                                <i class="fas fa-chevron-down"></i>
                                            </div>
                                            <div class="dropdown-options" id="punishmentTypeOptions">

                                            </div>
                                        </div>
                                        <input type="hidden" id="punishmentType" required>
                                    </div>
                                    <div id="durationContainer" class="hidden">
                                        <label for="duration" class="input-label">Duration</label>
                                        <div class="grid grid-cols-2 gap-4">
                                            <input type="number" id="durationValue" min="1" class="input-field" placeholder="Duration">
                                            <div class="custom-dropdown">
                                                <div class="dropdown-selected" id="durationUnitSelected">
                                                    <span>Minutes</span>
                                                    <i class="fas fa-chevron-down"></i>
                                                </div>
                                                <div class="dropdown-options" id="durationUnitOptions">
                                                    <div class="dropdown-option selected" data-value="minutes">Minutes</div>
                                                    <div class="dropdown-option" data-value="hours">Hours</div>
                                                    <div class="dropdown-option" data-value="days">Days</div>
                                                    <div class="dropdown-option" data-value="weeks">Weeks</div>
                                                </div>
                                            </div>
                                            <input type="hidden" id="durationUnit" value="minutes">
                                        </div>
                                    </div>
                                    <div>
                                        <label for="reason" class="input-label">Reason</label>
                                        <textarea id="reason" rows="2" class="input-field" placeholder="Enter reason" required></textarea>
                                    </div>
                                    <div class="flex justify-end">
                                        <button type="submit" id="submitBtn" class="btn btn-primary">
                                            Issue Punishment
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>

                        <div class="grid-item mb-6">
                            <div class="grid-item-header">
                                <h3>BOLO Management</h3>
                            </div>
                            <div class="grid-item-content">
                                <form id="boloForm" class="space-y-4">
                                    <div>
                                        <label for="boloUsername" class="input-label">Roblox Username</label>
                                        <input type="text" id="boloUsername" class="input-field" placeholder="Enter username" required>
                                    </div>
                                    <div>
                                        <label for="boloReason" class="input-label">Reason</label>
                                        <textarea id="boloReason" rows="2" class="input-field" placeholder="Enter reason" required></textarea>
                                    </div>
                                    <div class="flex justify-end">
                                        <button type="submit" id="submitBoloBtn" class="btn btn-primary">
                                            Create BOLO
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                        
                        <div class="grid-item">
                            <div class="grid-item-header">
                                <h3>Active BOLOs</h3>
                            </div>
                            <div class="grid-item-content">
                                <div id="activeBOLOs" class="space-y-3">
                                    <div class="text-center py-4">
                                        <div class="spinner mx-auto mb-2"></div>
                                        <p class="text-gray-400">Loading BOLOs...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-span-6 lg:col-span-6">
                        <div class="grid-item" style="height: 100%;">
                            <div class="grid-item-header">
                                <h3>Moderation Log</h3>
                                <p class="text-sm text-gray-400 mt-1">The moderation history for this server.</p>
                            </div>
                            <div class="moderation-log">
                                <div class="moderation-log-header">
                                    <div>Username</div>
                                    <div>Type</div>
                                    <div>Reason</div>
                                    <div>Date</div>
                                </div>
                                <div class="moderation-log-content">
                                    <div id="punishmentHistory" class="punishment-list space-y-3">
                                        <div class="text-center py-4">
                                            <div class="spinner mx-auto mb-2"></div>
                                            <p class="text-gray-400">Loading punishment history...</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="shiftsTab" class="hidden">
                <div class="grid-container">
                    <div class="col-span-6 lg:col-span-6">
                        <div class="grid-item mb-6">
                            <div class="grid-item-header">
                                <h3>Manage Shift</h3>
                                <p class="text-sm text-gray-400 mt-1">Track your on-duty time.</p>
                            </div>
                            <div class="grid-item-content">
                                <div class="p-4 bg-black/20 rounded-lg">
                                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4">
                                        <div class="flex items-center gap-3 mb-4 md:mb-0">
                                            <div id="shiftStatusIndicator" class="shift-status inactive">
                                                <div class="pulse inactive"></div>
                                                <span id="shiftStatusText">Off Duty</span>
                                            </div>
                                            <div class="text-2xl font-mono" id="shiftTimer">00:00:00</div>
                                        </div>
                                        <div class="w-full md:w-auto">
                                            <div class="custom-dropdown">
                                                <div class="dropdown-selected" id="shiftTypeSelected">
                                                    <span>Select type...</span>
                                                    <i class="fas fa-chevron-down"></i>
                                                </div>
                                                <div class="dropdown-options" id="shiftTypeOptions">

                                                </div>
                                            </div>
                                            <input type="hidden" id="shiftType" value="patrol">
                                        </div>
                                    </div>
                                    
                                    <div class="shift-controls">
                                        <button id="startShiftBtn" class="shift-btn shift-btn-start">
                                            <i class="fas fa-play"></i>
                                            <span>Start</span>
                                        </button>
                                        <button id="pauseShiftBtn" class="shift-btn shift-btn-pause" disabled>
                                            <i class="fas fa-pause"></i>
                                            <span>Pause</span>
                                        </button>
                                        <button id="endShiftBtn" class="shift-btn shift-btn-end" disabled>
                                            <i class="fas fa-stop"></i>
                                            <span>End</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="grid-item">
                            <div class="grid-item-header">
                                <h3>Your Recent Shifts</h3>
                            </div>
                            <div class="grid-item-content">
                                <div id="recentUserShifts" class="space-y-3">
                                    <div class="text-center py-4">
                                        <div class="spinner mx-auto mb-2"></div>
                                        <p class="text-gray-400">Loading your shifts...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-span-6 lg:col-span-6">
                        <div class="grid-item mb-6">
                            <div class="grid-item-header">
                                <h3>Active Staff</h3>
                                <p class="text-sm text-gray-400 mt-1">Currently on-duty staff members.</p>
                            </div>
                            <div class="grid-item-content">
                                <div id="activeShifts" class="grid grid-cols-1 gap-4">
                                    <div class="text-center py-4 col-span-full">
                                        <div class="spinner mx-auto mb-2"></div>
                                        <p class="text-gray-400">Loading active shifts...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="grid-item">
                            <div class="grid-item-header">
                                <h3>Recent Shifts</h3>
                            </div>
                            <div class="grid-item-content">
                                <div id="recentShifts" class="space-y-3">
                                    <div class="text-center py-4">
                                        <div class="spinner mx-auto mb-2"></div>
                                        <p class="text-gray-400">Loading recent shifts...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            
<div id="erlcTab" class="hidden">
    <div class="grid-container">
        <div class="col-span-12 lg:col-span-12 mb-6">
            <div class="grid-item">
                <div class="grid-item-header">
                    <h3>Server Information</h3>
                </div>
                <div class="grid-item-content">
                    <div id="erlcServerInfo" class="server-info-grid">
                        <div class="text-center py-4 col-span-full">
                            <div class="spinner mx-auto mb-2"></div>
                            <p class="text-gray-400">Loading server information...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-span-12 lg:col-span-8">
            <div class="grid-item mb-6">
                <div class="grid-item-header">
                    <h3>In-Game Players</h3>
                </div>
                <div class="grid-item-content">
                    <div id="erlcPlayersList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <div class="text-center py-4 col-span-full">
                            <div class="spinner mx-auto mb-2"></div>
                            <p class="text-gray-400">Loading players...</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="grid-item">
                <div class="grid-item-header">
                    <h3>Discord Checks</h3>
                </div>
                <div class="grid-item-content">
                    <p class="text-gray-400 mb-4">Check which players in-game are connected to Discord and view their voice channel status.</p>
                    <button id="runDiscordCheckBtn" class="btn btn-primary w-full sm:w-auto">
                        Run Discord Check
                    </button>
                    <div id="discordCheckCooldown" class="mt-2 text-sm text-gray-400 hidden">
                        <i class="fas fa-clock mr-1"></i> <span id="discordCheckCooldownTime"></span> until next check
                    </div>
                    
                    <div id="discordCheckResults" class="mt-6 space-y-3 hidden">
                        <h4 class="text-md font-semibold mb-3">Results</h4>
                        <div id="discordCheckList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 gap-4">

                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-span-12 lg:col-span-4">
            <div class="grid-item mb-6">
                <div class="grid-item-header">
                    <h3>Execute Command</h3>
                </div>
                <div class="grid-item-content">
                    <form id="commandForm" class="space-y-4">
                        <div>
                            <label for="command" class="input-label">Command</label>
                            <div class="flex">
                                <span class="inline-flex items-center px-3 py-2 bg-black/50 border border-r-0 border-white/10 rounded-l-md text-gray-400">:</span>
                                <input type="text" id="command" class="input-field rounded-l-none" placeholder="Enter command" required>
                            </div>
                        </div>
                        <div class="flex justify-end">
                            <button type="submit" id="executeCommandBtn" class="btn btn-primary w-full sm:w-auto">
                                Execute
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>


            <div id="automationsTab" class="hidden">
                <div class="grid-container">
                    <div class="col-span-12">
                        <div class="grid-item">
                            <div class="grid-item-header">
                                <h3>Custom Automations</h3>
                            </div>
                            <div class="grid-item-content">
                                <p class="text-gray-400 mb-4">Run your server's custom automations manually.</p>
                                
                                <div class="mb-4">
                                    <label for="automationSelector" class="input-label">Select Automation</label>
                                    <div class="custom-dropdown">
                                        <div class="dropdown-selected" id="automationSelected">
                                            <span>Select automation...</span>
                                            <i class="fas fa-chevron-down"></i>
                                        </div>
                                        <div class="dropdown-options" id="automationOptions">

                                        </div>
                                    </div>
                                    <input type="hidden" id="selectedAutomationId">
                                </div>
                                
                                <button id="runAutomationBtn" class="btn btn-primary" disabled>
                                    Run Automation
                                </button>
                                
                                <div id="automationDetails" class="mt-4 p-3 bg-black/20 rounded-lg hidden">
                                    <h4 class="font-medium mb-2">Automation Details</h4>
                                    <div class="space-y-2 text-sm">
                                        <div class="flex">
                                            <span class="text-gray-400 w-24">Trigger:</span>
                                            <span id="automationTrigger"></span>
                                        </div>
                                        <div class="flex">
                                            <span class="text-gray-400 w-24">Actions:</span>
                                            <div id="automationActions" class="flex-1"></div>
                                        </div>
                                        <div class="flex" id="automationRoleContainer">
                                            <span class="text-gray-400 w-24">Required Role:</span>
                                            <span id="automationRole"></span>
                                        </div>
                                        <div class="flex">
                                            <span class="text-gray-400 w-24">Created by:</span>
                                            <span id="automationAuthor"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <footer class="border-t border-[#F5FF82]/10 mt-8">
            <div class="max-w-7xl mx-auto px-4 py-12">
                <div class="flex flex-col md:flex-row justify-between items-center gap-8">
                    <div class="flex items-center gap-3">
                        <img src="https://duckybot.xyz/images/Ducky.svg" alt="Ducky" class="w-8 h-8">
                        <span class="text-xl font-bold text-[#F5FF82]">Ducky</span>
                    </div>
                    <div class="flex gap-6">
                        <a href="/legal/privacy/" class="text-gray-400 hover:text-[#F5FF82] transition">Privacy</a>
                        <a href="/legal/terms/" class="text-gray-400 hover:text-[#F5FF82] transition">Terms</a>
                        <a href="/support" class="text-gray-400 hover:text-[#F5FF82] transition">Support</a>
                    </div>
                </div>
                <p class="text-center text-gray-400 mt-8">© 2025 Ducky Bot. All rights reserved.</p>
            </div>
        </footer>

    <div id="confirmationModal" class="confirmation-modal">
        <div class="modal-content">
            <h3 class="text-lg font-bold mb-2">Confirm Deletion</h3>
            <p id="confirmationMessage">Are you sure you want to delete this punishment?</p>
            <div class="modal-actions">
                <button id="cancelDeleteBtn" class="btn btn-secondary">Cancel</button>
                <button id="confirmDeleteBtn" class="btn btn-danger">Delete</button>
            </div>
        </div>
    </div>

    <div id="toast" class="toast">
        <p id="toastMessage"></p>
    </div>

    <script>
    const loadingOverlay = document.getElementById('loadingOverlay');
    const serverGrid = document.getElementById('serverGrid');
    const serverSelectionView = document.getElementById('serverSelectionView');
    const moderationPanelView = document.getElementById('moderationPanelView');
    const backToServersBtn = document.getElementById('backToServersBtn');
    const punishmentsTabBtn = document.getElementById('punishmentsTabBtn');
    const shiftsTabBtn = document.getElementById('shiftsTabBtn');
    const erlcTabBtn = document.getElementById('erlcTabBtn');
    const automationsTabBtn = document.getElementById('automationsTabBtn');
    const punishmentsTab = document.getElementById('punishmentsTab');
    const shiftsTab = document.getElementById('shiftsTab');
    const erlcTab = document.getElementById('erlcTab');
    const automationsTab = document.getElementById('automationsTab');
    const punishmentForm = document.getElementById('punishmentForm');
    const punishmentType = document.getElementById('punishmentType');
    const durationContainer = document.getElementById('durationContainer');
    const punishmentHistory = document.getElementById('punishmentHistory');
    const activeShifts = document.getElementById('activeShifts');
    const recentShifts = document.getElementById('recentShifts');
    const toast = document.getElementById('toast');
    const toastMessage = document.getElementById('toastMessage');
    const menuBtn = document.getElementById('menuBtn');
    const closeMenuBtn = document.getElementById('closeMenuBtn');
    const mobileMenu = document.getElementById('mobileMenu');
    const confirmationModal = document.getElementById('confirmationModal');
    const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
    const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
    const confirmationMessage = document.getElementById('confirmationMessage');
    const startShiftBtn = document.getElementById('startShiftBtn');
    const pauseShiftBtn = document.getElementById('pauseShiftBtn');
    const endShiftBtn = document.getElementById('endShiftBtn');
    const shiftType = document.getElementById('shiftType');
    const shiftStatusIndicator = document.getElementById('shiftStatusIndicator');
    const shiftStatusText = document.getElementById('shiftStatusText');
    const shiftTimer = document.getElementById('shiftTimer');
    const recentUserShifts = document.getElementById('recentUserShifts');
    const runDiscordCheckBtn = document.getElementById('runDiscordCheckBtn');
    const discordCheckResults = document.getElementById('discordCheckResults');
    const discordCheckList = document.getElementById('discordCheckList');
    const erlcServerInfo = document.getElementById('erlcServerInfo');
    const erlcPlayersList = document.getElementById('erlcPlayersList');
    const boloForm = document.getElementById('boloForm');
    const activeBOLOs = document.getElementById('activeBOLOs');
    const commandForm = document.getElementById('commandForm');
    
    const punishmentTypeSelected = document.getElementById('punishmentTypeSelected');
    const punishmentTypeOptions = document.getElementById('punishmentTypeOptions');
    const durationUnitSelected = document.getElementById('durationUnitSelected');
    const durationUnitOptions = document.getElementById('durationUnitOptions');
    const durationUnit = document.getElementById('durationUnit');
    const shiftTypeSelected = document.getElementById('shiftTypeSelected');
    const shiftTypeOptions = document.getElementById('shiftTypeOptions');

    const discordCheckCooldown = document.getElementById('discordCheckCooldown');
    const discordCheckCooldownTime = document.getElementById('discordCheckCooldownTime');
    const automationSelected = document.getElementById('automationSelected');
    const automationOptions = document.getElementById('automationOptions');
    const selectedAutomationId = document.getElementById('selectedAutomationId');
    const runAutomationBtn = document.getElementById('runAutomationBtn');
    const automationDetails = document.getElementById('automationDetails');
    const automationTrigger = document.getElementById('automationTrigger');
    const automationActions = document.getElementById('automationActions');
    const automationRole = document.getElementById('automationRole');
    const automationRoleContainer = document.getElementById('automationRoleContainer');
    const automationAuthor = document.getElementById('automationAuthor');

    let selectedServerId = null;
    let selectedServerConfig = null;
    let userCache = new Map();
    let avatarCache = new Map();
    let discordToken = null;
    let discordUser = null;
    let lastPunishmentTime = 0;
    const PUNISHMENT_COOLDOWN = 5000;
    
    let shiftStatus = 'inactive';
    let shiftStartTime = 0;
    let shiftElapsedTime = 0;
    let shiftTimerInterval = null;
    let currentPunishmentToDelete = null;
    let currentUserShift = null;

    let discordCheckCooldowns = {};
    const DISCORD_CHECK_COOLDOWN = 5 * 60 * 1000; 

    let serverAutomations = [];

    function updateDiscordCheckCooldown() {
        if (!selectedServerId || !discordCheckCooldowns[selectedServerId]) {
            discordCheckCooldown.classList.add('hidden');
            return;
        }
        
        const cooldownEnd = discordCheckCooldowns[selectedServerId];
        const now = Date.now();
        const timeLeft = cooldownEnd - now;
        
        if (timeLeft <= 0) {
            discordCheckCooldown.classList.add('hidden');
            runDiscordCheckBtn.disabled = false;
            return;
        }
        
        const minutes = Math.floor(timeLeft / 60000);
        const seconds = Math.floor((timeLeft % 60000) / 1000);
        discordCheckCooldownTime.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        discordCheckCooldown.classList.remove('hidden');
        runDiscordCheckBtn.disabled = true;
        
        setTimeout(updateDiscordCheckCooldown, 1000);
    }

    function setupAutomationsDropdown(automations) {
        serverAutomations = automations || [];
        automationOptions.innerHTML = '';
        
        if (!automations || automations.length === 0) {
            const option = document.createElement('div');
            option.className = 'dropdown-option';
            option.textContent = 'No automations available';
            automationOptions.appendChild(option);
            runAutomationBtn.disabled = true;
            return;
        }
        
        const manualAutomations = automations.filter(automation => 
            automation.trigger && automation.trigger.value === 'manual'
        );
        
        if (manualAutomations.length === 0) {
            const option = document.createElement('div');
            option.className = 'dropdown-option';
            option.textContent = 'No manual automations available';
            automationOptions.appendChild(option);
            runAutomationBtn.disabled = true;
            return;
        }
        
        manualAutomations.forEach((automation, index) => {
            const option = document.createElement('div');
            option.className = 'dropdown-option';
            const originalIndex = automations.findIndex(a => a.name === automation.name);
            option.dataset.index = originalIndex;
            option.textContent = automation.name;
            
            option.addEventListener('click', () => {
                selectedAutomationId.value = originalIndex;
                automationSelected.querySelector('span').textContent = automation.name;
                
                document.querySelectorAll('#automationOptions .dropdown-option').forEach(opt => {
                    opt.classList.remove('selected');
                });
                option.classList.add('selected');
                
                automationSelected.classList.remove('active');
                automationOptions.classList.remove('active');
                
                showAutomationDetails(automation);
                runAutomationBtn.disabled = false;
            });
            
            automationOptions.appendChild(option);
        });
    }

    function showAutomationDetails(automation) {
        automationTrigger.textContent = automation.trigger ? automation.trigger.name : 'Unknown';
        
        automationActions.innerHTML = '';
        if (automation.actions && automation.actions.length > 0) {
            const actionsList = document.createElement('ul');
            actionsList.className = 'list-disc pl-5';
            
            automation.actions.forEach(action => {
                const actionItem = document.createElement('li');
                actionItem.textContent = action.name;
                actionsList.appendChild(actionItem);
            });
            
            automationActions.appendChild(actionsList);
        } else {
            automationActions.textContent = 'No actions defined';
        }
        
        if (automation.role) {
            automationRole.textContent = `<@&${automation.role}>`;
            automationRoleContainer.classList.remove('hidden');
        } else {
            automationRoleContainer.classList.add('hidden');
        }
        
        if (automation.author) {
            fetchUserData(automation.author).then(userData => {
                automationAuthor.textContent = userData.username || userData.name || automation.author;
            });
        } else {
            automationAuthor.textContent = 'Unknown';
        }
        
        automationDetails.classList.remove('hidden');
    }

    async function runAutomation() {
        if (!discordToken || !selectedServerId || selectedAutomationId.value === '') {
            showToast('Please select an automation to run', 'error');
            return;
        }
        
        const automationIndex = parseInt(selectedAutomationId.value);
        if (isNaN(automationIndex) || automationIndex < 0 || automationIndex >= serverAutomations.length) {
            showToast('Invalid automation selected', 'error');
            return;
        }
        
        const automation = serverAutomations[automationIndex];
        if (!automation) {
            showToast('Invalid automation selected', 'error');
            return;
        }
        
        try {
            runAutomationBtn.disabled = true;
            runAutomationBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Running...';
            
            const response = await fetch(`https://api.duckybot.xyz/guilds/${selectedServerId}/automations/${automationIndex}`, {
                method: 'POST',
                headers: {
                    'Discord-Code': discordToken
                }
            });
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || 'Failed to run automation');
            }
            
            showToast(`Successfully ran automation: ${automation.name}`);
            
        } catch (error) {
            showToast('Failed to run automation: ' + error.message, 'error');
        } finally {
            runAutomationBtn.disabled = false;
            runAutomationBtn.innerHTML = 'Run Automation';
        }
    }

    function initDropdowns() {
        punishmentTypeSelected.addEventListener('click', () => {
            punishmentTypeSelected.classList.toggle('active');
            punishmentTypeOptions.classList.toggle('active');
        });
        
        durationUnitSelected.addEventListener('click', () => {
            durationUnitSelected.classList.toggle('active');
            durationUnitOptions.classList.toggle('active');
        });
        
        document.querySelectorAll('#durationUnitOptions .dropdown-option').forEach(option => {
            option.addEventListener('click', () => {
                const value = option.dataset.value;
                durationUnit.value = value;
                durationUnitSelected.querySelector('span').textContent = option.textContent;
                
                document.querySelectorAll('#durationUnitOptions .dropdown-option').forEach(opt => {
                    opt.classList.remove('selected');
                });
                option.classList.add('selected');
                
                durationUnitSelected.classList.remove('active');
                durationUnitOptions.classList.remove('active');
            });
        });
        
        shiftTypeSelected.addEventListener('click', () => {
            shiftTypeSelected.classList.toggle('active');
            shiftTypeOptions.classList.toggle('active');
        });
        
        automationSelected.addEventListener('click', () => {
            automationSelected.classList.toggle('active');
            automationOptions.classList.toggle('active');
        });
        
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.custom-dropdown')) {
                document.querySelectorAll('.dropdown-options').forEach(dropdown => {
                    dropdown.classList.remove('active');
                });
                document.querySelectorAll('.dropdown-selected').forEach(selected => {
                    selected.classList.remove('active');
                });
            }
        });
    }

    function getDiscordToken() {
        return document.cookie.split('; ').find(row => row.startsWith('discord='))?.split('=')[1];
    }

    function formatDuration(seconds) {
        if (seconds < 60) return `${seconds} second${seconds !== 1 ? 's' : ''}`;
        
        const months = Math.floor(seconds / (30 * 24 * 3600));
        const remainingAfterMonths = seconds % (30 * 24 * 3600);
        const weeks = Math.floor(remainingAfterMonths / (7 * 24 * 3600));
        const remainingAfterWeeks = remainingAfterMonths % (7 * 24 * 3600);
        const hours = Math.floor(remainingAfterWeeks / 3600);
        const remainingAfterHours = remainingAfterWeeks % 3600;
        const minutes = Math.floor(remainingAfterHours / 60);
        const secs = remainingAfterHours % 60;
        
        let durationString = '';
        if (months > 0) durationString += `${months} month${months !== 1 ? 's' : ''}`;
        if (weeks > 0) durationString += `${durationString ? ', ' : ''}${weeks} week${weeks !== 1 ? 's' : ''}`;
        if (hours > 0) durationString += `${durationString ? ', ' : ''}${hours} hour${hours !== 1 ? 's' : ''}`;
        if (minutes > 0) durationString += `${durationString ? ', ' : ''}${minutes} minute${minutes !== 1 ? 's' : ''}`;
        if (secs > 0 || (months === 0 && weeks === 0 && hours === 0 && minutes === 0)) {
            durationString += `${durationString ? ', ' : ''}${secs} second${secs !== 1 ? 's' : ''}`;
        }
        
        return durationString;
    }
    
    function formatShiftTime(seconds) {
        const hours = Math.floor(seconds / 3600);
        const minutes = Math.floor((seconds % 3600) / 60);
        const secs = seconds % 60;
        
        return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    }

    function formatDate(timestamp) {
        const date = new Date(timestamp * 1000);
        return date.toLocaleString();
    }

    function showToast(message, type = 'success') {
        toastMessage.textContent = message;
        toast.className = `toast ${type}`;
        toast.classList.add('show');
        
        setTimeout(() => {
            toast.classList.remove('show');
        }, 3000);
    }

    async function fetchUserData(userId, forceRefresh = false) {
        if (!forceRefresh && userCache.has(userId)) {
            return userCache.get(userId);
        }
        
        try {
            const response = await fetch(`https://api.duckybot.xyz/user/${userId}`);
            
            if (!response.ok) {
                return { id: userId, name: userId, username: userId };
            }
            
            const data = await response.json();
            
            if (data.code === 200 && data.data) {
                userCache.set(userId, data.data);
                return data.data;
            }
            
            return { id: userId, name: userId, username: username };
        } catch (error) {
            return { id: userId, name: userId, username: username };
        }
    }

    menuBtn.addEventListener('click', () => {
        mobileMenu.classList.add('active');
        document.body.style.overflow = 'hidden';
    });

    closeMenuBtn.addEventListener('click', () => {
        mobileMenu.classList.remove('active');
        document.body.style.overflow = '';
    });

    function setupPunishmentTypeDropdown(types) {
        punishmentTypeOptions.innerHTML = '';
        
        types.forEach((type, index) => {
            const option = document.createElement('div');
            option.className = 'dropdown-option';
            option.dataset.value = type.toLowerCase();
            option.textContent = type;
            
            option.addEventListener('click', () => {
                punishmentType.value = type.toLowerCase();
                punishmentTypeSelected.querySelector('span').textContent = option.textContent;
                
                document.querySelectorAll('#punishmentTypeOptions .dropdown-option').forEach(opt => {
                    opt.classList.remove('selected');
                });
                option.classList.add('selected');
                
                punishmentTypeSelected.classList.remove('active');
                punishmentTypeOptions.classList.remove('active');
                
                durationContainer.classList.toggle('hidden', punishmentType.value !== 'tempban');
            });
            
            punishmentTypeOptions.appendChild(option);
        });
    }

    function setupShiftTypeDropdown(types) {
        shiftTypeOptions.innerHTML = '';
        
        if (!types || types.length === 0) {
            types = [];
        }
        
        types.forEach((type, index) => {
            const option = document.createElement('div');
            option.className = 'dropdown-option';
            option.dataset.value = type.name.toLowerCase();
            option.textContent = type.name;
            
            if (index === 0) {
                option.classList.add('selected');
                shiftTypeSelected.querySelector('span').textContent = option.textContent;
                shiftType.value = type.name.toLowerCase();
            }
            
            option.addEventListener('click', () => {
                const oldType = shiftType.value;
                shiftType.value = type.name.toLowerCase();
                shiftTypeSelected.querySelector('span').textContent = option.textContent;
                
                document.querySelectorAll('#shiftTypeOptions .dropdown-option').forEach(opt => {
                    opt.classList.remove('selected');
                });
                option.classList.add('selected');
                
                shiftTypeSelected.classList.remove('active');
                shiftTypeOptions.classList.remove('active');
                
                if (shiftStatus !== 'inactive' && oldType !== shiftType.value) {
                    resetShiftUI();
                    checkActiveShift(selectedServerId);
                }
            });
            
            shiftTypeOptions.appendChild(option);
        });
    }
    
    function resetShiftUI() {
        if (shiftTimerInterval) {
            clearInterval(shiftTimerInterval);
            shiftTimerInterval = null;
        }
        
        shiftStatus = 'inactive';
        shiftStartTime = 0;
        shiftElapsedTime = 0;
        currentUserShift = null;
        
        updateShiftUI();
    }
    
    function clearPreviousServerData() {
        punishmentHistory.innerHTML = '<div class="text-center py-4"><div class="spinner mx-auto mb-2"></div><p class="text-gray-400">Loading punishment history...</p></div>';
        
        if (activeBOLOs) {
            activeBOLOs.innerHTML = '<div class="text-center py-4"><div class="spinner mx-auto mb-2"></div><p class="text-gray-400">Loading BOLOs...</p></div>';
        }
        
        activeShifts.innerHTML = '<div class="text-center py-4 col-span-full"><div class="spinner mx-auto mb-2"></div><p class="text-gray-400">Loading active shifts...</p></div>';
        recentShifts.innerHTML = '<div class="text-center py-4"><div class="spinner mx-auto mb-2"></div><p class="text-gray-400">Loading recent shifts...</p></div>';
        recentUserShifts.innerHTML = '<div class="text-center py-4"><div class="spinner mx-auto mb-2"></div><p class="text-gray-400">Loading your shifts...</p></div>';
        
        erlcServerInfo.innerHTML = '<div class="text-center py-4 col-span-full"><div class="spinner mx-auto mb-2"></div><p class="text-gray-400">Loading server information...</p></div>';
        erlcPlayersList.innerHTML = '<div class="text-center py-4 col-span-full"><div class="spinner mx-auto mb-2"></div><p class="text-gray-400">Loading players...</p></div>';
        
        discordCheckResults.classList.add('hidden');
        
        resetShiftUI();
    }
    
    backToServersBtn.addEventListener('click', () => {
        moderationPanelView.classList.add('hidden');
        serverSelectionView.classList.remove('hidden');
        localStorage.removeItem('selectedServerId');
        
        resetShiftUI();
        clearPreviousServerData();
    });

    punishmentsTabBtn.addEventListener('click', () => {
        punishmentsTabBtn.classList.add('active');
        shiftsTabBtn.classList.remove('active');
        erlcTabBtn.classList.remove('active');
        automationsTabBtn.classList.remove('active');
        punishmentsTab.classList.remove('hidden');
        shiftsTab.classList.add('hidden');
        erlcTab.classList.add('hidden');
        automationsTab.classList.add('hidden');
    });

    shiftsTabBtn.addEventListener('click', () => {
        shiftsTabBtn.classList.add('active');
        punishmentsTabBtn.classList.remove('active');
        erlcTabBtn.classList.remove('active');
        automationsTabBtn.classList.remove('active');
        shiftsTab.classList.remove('hidden');
        punishmentsTab.classList.add('hidden');
        erlcTab.classList.add('hidden');
        automationsTab.classList.add('hidden');
        
        if (activeShifts.innerHTML.includes('Loading')) {
            loadShifts(selectedServerId);
        }
    });

    erlcTabBtn.addEventListener('click', () => {
        erlcTabBtn.classList.add('active');
        punishmentsTabBtn.classList.remove('active');
        shiftsTabBtn.classList.remove('active');
        automationsTabBtn.classList.remove('active');
        erlcTab.classList.remove('hidden');
        punishmentsTab.classList.add('hidden');
        shiftsTab.classList.add('hidden');
        automationsTab.classList.add('hidden');
        
        loadERLCData(selectedServerId);
        loadBOLOs(selectedServerId);
    });

    automationsTabBtn.addEventListener('click', () => {
        automationsTabBtn.classList.add('active');
        punishmentsTabBtn.classList.remove('active');
        shiftsTabBtn.classList.remove('active');
        erlcTabBtn.classList.remove('active');
        automationsTab.classList.remove('hidden');
        punishmentsTab.classList.add('hidden');
        shiftsTab.classList.add('hidden');
        erlcTab.classList.add('hidden');
    });

    punishmentForm.addEventListener('submit', function(e) {
        e.preventDefault();
        issuePunishment();
    });
    
    if (boloForm) {
        boloForm.addEventListener('submit', function(e) {
            e.preventDefault();
            createBOLO();
        });
    }
    
    if (commandForm) {
        commandForm.addEventListener('submit', function(e) {
            e.preventDefault();
            executeCommand();
        });
    }
    
    startShiftBtn.addEventListener('click', startShift);
    pauseShiftBtn.addEventListener('click', pauseShift);
    endShiftBtn.addEventListener('click', endShift);
    runAutomationBtn.addEventListener('click', runAutomation);
    
    confirmDeleteBtn.addEventListener('click', confirmDeletePunishment);
    cancelDeleteBtn.addEventListener('click', () => {
        confirmationModal.classList.remove('active');
        currentPunishmentToDelete = null;
    });

    function selectServer(serverId, serverName, serverIcon, serverConfig) {
        clearPreviousServerData();
        
        selectedServerId = serverId;
        selectedServerConfig = serverConfig;
        
        document.getElementById('serverName').textContent = serverName;
        document.getElementById('serverIcon').src = serverIcon || 'https://duckybot.xyz/images/Ducky.svg';
        
        serverSelectionView.classList.add('hidden');
        moderationPanelView.classList.remove('hidden');
        
        localStorage.setItem('selectedServerId', JSON.stringify({
            id: serverId,
            name: serverName,
            icon: serverIcon,
            config: serverConfig
        }));
        
        let punishmentTypes = [];
        if (serverConfig && serverConfig.punishmenttypes && serverConfig.punishmenttypes.length > 0) {
            punishmentTypes = serverConfig.punishmenttypes;
        }
        setupPunishmentTypeDropdown(punishmentTypes);
        
        let shiftTypes = [];
        if (serverConfig && serverConfig.shifttypes && serverConfig.shifttypes.length > 0) {
            shiftTypes = serverConfig.shifttypes;
        }
        setupShiftTypeDropdown(shiftTypes);
        
        if (serverConfig && serverConfig.automations) {
            setupAutomationsDropdown(serverConfig.automations);
        } else {
            setupAutomationsDropdown([]);
        }
        
        loadPunishments(serverId);
        loadBOLOs(serverId);
        checkActiveShift(serverId);
        updateDiscordCheckCooldown();
    }
    
    async function loadServers() {
        discordToken = getDiscordToken();
        
        if (!discordToken) {
            window.location.href = "/login?redirect=modpanel";
            return;
        }
        
        const savedServer = localStorage.getItem('selectedServerId');
        if (savedServer) {
            try {
                const serverData = JSON.parse(savedServer);
                if (serverData && serverData.id) {
                    selectedServerId = serverData.id;
                }
            } catch (e) {
                localStorage.removeItem('selectedServerId');
            }
        }

        try {
            const response = await fetch("https://api.duckybot.xyz/guilds", {
                headers: { "Discord-Code": discordToken }
            });

            if (!response.ok) {
                throw new Error('Failed to fetch data');
            }

            const { data: servers, code } = await response.json();
            
            if (code !== 200 || !servers) {
                throw new Error('Invalid response from server');
            }
            
            const userResponse = await fetch('https://discord.com/api/users/@me', {
                headers: { authorization: `Bearer ${discordToken}` }
            });
            
            if (userResponse.ok) {
                discordUser = await userResponse.json();
                document.getElementById('username').textContent = discordUser.global_name || discordUser.username;
                const avatarUrl = `https://cdn.discordapp.com/avatars/${discordUser.id}/${discordUser.avatar}.png`;
                document.getElementById('profilePicture').src = avatarUrl;
            }
            
            const filteredServers = servers.filter(server => server.manage_server && server.ducky);
            
            if (filteredServers.length === 0) {
                serverGrid.innerHTML = '<div class="empty-state col-span-full"><i class="fas fa-server"></i><p>No servers with Ducky found. Make sure you have the right permissions.</p></div>';
            } else {
                serverGrid.innerHTML = '';
                
                const fragment = document.createDocumentFragment();
                
                let savedServerValid = false;
                let savedServerData = null;
                
                if (selectedServerId) {
                    savedServerData = filteredServers.find(server => server.id === selectedServerId);
                    if (savedServerData) {
                        savedServerValid = true;
                    }
                }
                
                filteredServers.forEach(server => {
                    const serverCard = document.createElement('div');
                    serverCard.className = 'server-card';
                    
                    const img = document.createElement('img');
                    img.src = server.icon || 'https://duckybot.xyz/images/Ducky.svg';
                    img.alt = server.name;
                    img.loading = 'lazy';

                    const name = document.createElement('p');
                    name.className = 'text-center font-medium text-xs';
                    name.textContent = server.name;
                    
                    serverCard.appendChild(img);
                    serverCard.appendChild(name);
                    
                    serverCard.addEventListener('click', () => {
                        selectServer(server.id, server.name, server.icon, server.config);
                    });
                    
                    fragment.appendChild(serverCard);
                });
                
                serverGrid.appendChild(fragment);
                
                if (savedServerValid && savedServerData) {
                    selectServer(savedServerData.id, savedServerData.name, savedServerData.icon, savedServerData.config);
                }
            }
            
            loadingOverlay.classList.add('fade-out');
            setTimeout(() => {
                loadingOverlay.style.display = 'none';
                serverSelectionView.style.opacity = '1';
            }, 500);
            
        } catch (error) {
            serverGrid.innerHTML = '<div class="empty-state col-span-full"><i class="fas fa-exclamation-triangle"></i><p>Failed to load servers. Please try again later.</p></div>';
            loadingOverlay.classList.add('fade-out');
            setTimeout(() => {
                loadingOverlay.style.display = 'none';
                serverSelectionView.style.opacity = '1';
            }, 500);
        }
    }

async function loadPunishments(serverId) {
    punishmentHistory.innerHTML = `
        <div class="text-center py-4">
            <div class="spinner mx-auto mb-2"></div>
            <p class="text-gray-400">Loading punishment history...</p>
        </div>
    `;
    
    if (!discordToken) {
        punishmentHistory.innerHTML = '<div class="empty-state"><i class="fas fa-exclamation-triangle"></i><p>Authentication error. Please log in again.</p></div>';
        return;
    }
    
    try {
        const response = await fetch(`https://api.duckybot.xyz/guilds/${serverId}/punishments`, {
            headers: { "Discord-Code": discordToken }
        });
        
        if (!response.ok) {
            throw new Error('Failed to fetch punishments');
        }
        
        const { data: punishments } = await response.json();
        
        if (!punishments || punishments.length === 0) {
            punishmentHistory.innerHTML = '<div class="empty-state"><i class="fas fa-ban"></i><p>No punishment history found.</p></div>';
            return;
        }
        
        punishmentHistory.innerHTML = '';
        
        punishments.sort((a, b) => b.timestamp - a.timestamp);
        
        const fragment = document.createDocumentFragment();
        
        for (const punishment of punishments) {
            const item = document.createElement('div');
            item.className = 'punishment-item';
            item.dataset.punishmentId = punishment.punishmentid || punishment.id;
            item.dataset.username = (punishment.robloxUser.name || '').toLowerCase();
            item.dataset.displayname = (punishment.robloxUser.displayName || '').toLowerCase();
            item.dataset.robloxid = (punishment.robloxUser.id || 0).toString();
            
            const typeColors = {
                warn: 'text-yellow-400',
                warning: 'text-yellow-400',
                kick: 'text-orange-400',
                ban: 'text-red-500',
                tempban: 'text-red-400'
            };
            
            const typeColor = typeColors[punishment.type.toLowerCase()] || 'text-gray-400';
            
            const moderatorData = await fetchUserData(punishment.moderator);
            const moderatorName = moderatorData.username || moderatorData.name || punishment.moderator;
            
            let avatarUrl = punishment.robloxUser.pfpURL || punishment.robloxUser.avatar;
            if (!avatarUrl && punishment.robloxUser.id) {
                const robloxData = await fetchUserData(punishment.robloxUser.id);
                avatarUrl = robloxData.avatar;
            }
            
            const userInfoDiv = document.createElement('div');
            userInfoDiv.className = 'user-info';
            
            const avatarDiv = document.createElement('div');
            avatarDiv.className = 'avatar-circle hidden sm:flex';
            avatarDiv.style.backgroundColor = '#1e1e1e';
            avatarDiv.style.border = '1px solid rgba(255, 255, 255, 0.1)';
            
            if (avatarUrl) {
                const img = document.createElement('img');
                img.src = avatarUrl;
                img.alt = punishment.robloxUser.name;
                avatarDiv.appendChild(img);
            } else {
                avatarDiv.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#e74c3c" width="24" height="24">
                    <path d="M3 6h18v2H3V6zm0 5h18v2H3v-2zm0 5h18v2H3v-2z"/>
                </svg>`;
            }
            
            const userTextDiv = document.createElement('div');
            userTextDiv.innerHTML = `
                <div class="font-medium">${punishment.robloxUser.name}</div>
                <div class="text-sm text-gray-400">@${punishment.robloxUser.name}</div>
            `;
            
            userInfoDiv.appendChild(avatarDiv);
            userInfoDiv.appendChild(userTextDiv);
            
            const typeDiv = document.createElement('div');
            typeDiv.className = `punishment-type ${typeColor}`;
            typeDiv.textContent = punishment.type.toUpperCase();
            
            const reasonDiv = document.createElement('div');
            reasonDiv.className = 'punishment-reason text-gray-400';
            reasonDiv.textContent = punishment.reason;
            
            const metaDiv = document.createElement('div');
            metaDiv.className = 'meta-info';
            metaDiv.innerHTML = `
                <div class="text-gray-500">${formatDate(punishment.timestamp)}</div>
                <div class="text-gray-400">By: ${moderatorName}</div>
            `;
            
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'delete-btn';
            deleteBtn.title = 'Delete punishment';
            deleteBtn.innerHTML = '<i class="fas fa-trash-alt"></i>';
            deleteBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                showDeleteConfirmation(punishment.punishmentid || punishment.id, punishment.robloxUser.name, punishment.type);
            });
            
            item.appendChild(userInfoDiv);
            item.appendChild(typeDiv);
            item.appendChild(reasonDiv);
            item.appendChild(metaDiv);
            item.appendChild(deleteBtn);
            
            fragment.appendChild(item);
        }
        
        punishmentHistory.appendChild(fragment);
        
        const robloxUsername = document.getElementById('robloxUsername');
        robloxUsername.addEventListener('input', filterPunishmentHistory);
        
    } catch (error) {
        punishmentHistory.innerHTML = '<div class="empty-state"><i class="fas fa-exclamation-triangle"></i><p>Failed to load punishment history. Please try again.</p></div>';
    }
}

    function filterPunishmentHistory() {
        const username = document.getElementById('robloxUsername').value.trim().toLowerCase();
        const punishmentItems = document.querySelectorAll('#punishmentHistory .punishment-item');
        
        if (!username) {
            punishmentItems.forEach(item => {
                item.style.display = '';
            });
            return;
        }
        
        let matchFound = false;
        
        punishmentItems.forEach(item => {
            const itemUsername = item.dataset.username || '';
            const itemDisplayName = item.dataset.displayname || '';
            const itemRobloxId = item.dataset.robloxid || '';
            
            if (itemUsername.includes(username) || itemDisplayName.includes(username) || itemRobloxId === username) {
                item.style.display = '';
                matchFound = true;
            } else {
                item.style.display = 'none';
            }
        });
        
        if (!matchFound) {
            if (!document.getElementById('no-matches-message')) {
                const noMatches = document.createElement('div');
                noMatches.id = 'no-matches-message';
                noMatches.className = 'empty-state';
                noMatches.innerHTML = '<i class="fas fa-search"></i><p>No matching punishments found.</p></div>';
                punishmentHistory.appendChild(noMatches);
            }
        } else {
            const noMatches = document.getElementById('no-matches-message');
            if (noMatches) {
                noMatches.remove();
            }
        }
    }
    
    function showDeleteConfirmation(punishmentId, username, type) {
        currentPunishmentToDelete = punishmentId;
        confirmationMessage.textContent = `Are you sure you want to delete the ${type.toUpperCase()} punishment for ${username}?`;
        confirmationModal.classList.add('active');
    }
    
    async function confirmDeletePunishment() {
        if (!currentPunishmentToDelete || !selectedServerId || !discordToken) {
            showToast('Error: Missing information for deletion', 'error');
            confirmationModal.classList.remove('active');
            return;
        }
        
        try {
            const response = await fetch(`https://api.duckybot.xyz/guilds/${selectedServerId}/punishments/${currentPunishmentToDelete}`, {
                method: 'DELETE',
                headers: {
                    'Discord-Code': discordToken
                }
            });
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error('Failed to delete punishment');
            }
            
            showToast('Punishment deleted successfully');
            
            const punishmentElement = document.querySelector(`.punishment-item[data-punishment-id="${currentPunishmentToDelete}"]`);
            if (punishmentElement) {
                punishmentElement.style.height = punishmentElement.offsetHeight + 'px';
                punishmentElement.style.overflow = 'hidden';
                
                setTimeout(() => {
                    punishmentElement.style.height = '0';
                    punishmentElement.style.padding = '0';
                    punishmentElement.style.margin = '0';
                    punishmentElement.style.opacity = '0';
                    
                    setTimeout(() => {
                        punishmentElement.remove();
                        
                        if (punishmentHistory.children.length === 0) {
                            punishmentHistory.innerHTML = '<div class="empty-state"><i class="fas fa-ban"></i><p>No punishment history found.</p></div>';
                        }
                    }, 300);
                }, 10);
            }
            
        } catch (error) {
            showToast('Failed to delete punishment: ' + error.message, 'error');
        } finally {
            confirmationModal.classList.remove('active');
            currentPunishmentToDelete = null;
        }
    }

    async function loadShifts(serverId) {
        activeShifts.innerHTML = `
            <div class="text-center py-4 col-span-full">
                <div class="spinner mx-auto mb-2"></div>
                <p class="text-gray-400">Loading active shifts...</p>
            </div>
        `;
        
        recentShifts.innerHTML = `
            <div class="text-center py-4">
                <div class="spinner mx-auto mb-2"></div>
                <p class="text-gray-400">Loading recent shifts...</p>
            </div>
        `;
        
        if (!discordToken) {
            activeShifts.innerHTML = '<div class="empty-state col-span-full"><i class="fas fa-exclamation-triangle"></i><p>Authentication error. Please log in again.</p></div>';
            recentShifts.innerHTML = '<div class="empty-state"><i class="fas fa-exclamation-triangle"></i><p>Authentication error. Please log in again.</p></div>';
            return;
        }
        
        try {
            const response = await fetch(`https://api.duckybot.xyz/guilds/${serverId}/shifts`, {
                headers: { "Discord-Code": discordToken }
            });
            
            if (!response.ok) {
                throw new Error('Failed to fetch shifts');
            }
            
            const { data } = await response.json();
            
            if (!data.activeshifts || data.activeshifts.length === 0) {
                activeShifts.innerHTML = '<div class="empty-state col-span-full"><i class="fas fa-user-clock"></i><p>No active shifts found.</p></div>';
            } else {
                activeShifts.innerHTML = '';
                
                const fragment = document.createDocumentFragment();
                
                for (const shift of data.activeshifts) {
                    const duration = Math.floor(Date.now() / 1000 - shift.started);
                    const userData = await fetchUserData(shift.user);
                    
                    const card = document.createElement('div');
                    card.className = 'active-staff-item';
                    
                    const avatarUrl = userData.avatar;
                    
                    card.innerHTML = `
                        <div class="avatar-circle">
                            ${avatarUrl ? `<img src="${avatarUrl}" alt="${userData.username || userData.name || shift.user}">` : (userData.username || userData.name || shift.user).charAt(0)}
                        </div>
                        <div class="staff-info">
                            <div class="staff-name">${userData.username || userData.name || shift.user}</div>
                            <div class="staff-status">Active for ${formatDuration(duration)}</div>
                            <div class="text-xs text-gray-400 mt-1">Type: ${shift.type || 'Default'}</div>
                        </div>
                        <div class="staff-active-badge">
                            <i class="fas fa-circle mr-1"></i> Active
                        </div>
                    `;
                    
                    fragment.appendChild(card);
                }
                
                activeShifts.appendChild(fragment);
            }
            
            if (!data.shifts || data.shifts.length === 0) {
                recentShifts.innerHTML = '<div class="empty-state"><i class="fas fa-history"></i><p>No recent shifts found.</p></div>';
            } else {
                recentShifts.innerHTML = '';
                
                const fragment = document.createDocumentFragment();
                
                const sortedShifts = data.shifts
                    .sort((a, b) => b.ended - a.ended)
                    .slice(0, 5);
                
                for (const shift of sortedShifts) {
                    const userData = await fetchUserData(shift.user);
                    
                    const item = document.createElement('div');
                    item.className = 'shift-card';
                    
                    const avatarUrl = userData.avatar;
                    const actualDuration = shift.elapsed > 0 ? shift.elapsed * 60 : 0;
                    
                    item.innerHTML = `
                        <div class="avatar-circle">
                            ${avatarUrl ? `<img src="${avatarUrl}" alt="${userData.username || userData.name || shift.user}">` : (userData.username || userData.name || shift.user).charAt(0)}
                        </div>
                        <div class="flex-1">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h4 class="font-medium">${userData.username || userData.name || shift.user}</h4>
                                    <p class="text-sm text-gray-400 mt-1">Duration: ${formatDuration(actualDuration)}</p>
                                    <p class="text-xs text-gray-400 mt-1">Type: ${shift.type || 'Default'}</p>
                                </div>
                                <div class="text-right">
                                    <p class="text-xs text-gray-500">Ended: ${formatDate(shift.ended)}</p>
                                    <p class="text-xs text-gray-400 mt-1">Punishments: ${shift.punishments}</p>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    fragment.appendChild(item);
                }
                
                recentShifts.appendChild(fragment);
            }
            
            if (discordUser) {
                const userId = discordUser.id;
                const userActiveShift = data.activeshifts?.find(shift => shift.user === userId && shift.type === shiftType.value);
                
                if (userActiveShift) {
                    currentUserShift = userActiveShift;
                    shiftStatus = userActiveShift.paused ? 'paused' : 'active';
                    shiftStartTime = userActiveShift.started;
                    shiftElapsedTime = userActiveShift.elapsed || 0;
                    
                    updateShiftUI();
                    
                    if (shiftStatus === 'active') {
                        startShiftTimer();
                    }
                }
            }
            
            loadUserRecentShifts(serverId, data);
            
        } catch (error) {
            activeShifts.innerHTML = '<div class="empty-state col-span-full"><i class="fas fa-exclamation-triangle"></i><p>Failed to load active shifts. Please try again.</p></div>';
            recentShifts.innerHTML = '<div class="empty-state"><i class="fas fa-exclamation-triangle"></i><p>Failed to load recent shifts. Please try again.</p></div>';
        }
    }
    
    async function loadUserRecentShifts(serverId, shiftData) {
        if (!discordToken || !discordUser) {
            recentUserShifts.innerHTML = '<div class="empty-state"><i class="fas fa-exclamation-triangle"></i><p>Authentication error. Please log in again.</p></div>';
            return;
        }
        
        try {
            const userId = discordUser.id;
            
            if (!shiftData || !shiftData.shifts || shiftData.shifts.length === 0) {
                recentUserShifts.innerHTML = '<div class="empty-state"><i class="fas fa-history"></i><p>No shift history found.</p></div>';
                return;
            }
            
            const userShifts = shiftData.shifts.filter(shift => shift.user === userId);
            
            if (userShifts.length === 0) {
                recentUserShifts.innerHTML = '<div class="empty-state"><i class="fas fa-history"></i><p>No shift history found.</p></div>';
                return;
            }
            
            recentUserShifts.innerHTML = '';
            
            const fragment = document.createDocumentFragment();
            
            userShifts.sort((a, b) => b.ended - a.ended);
            
            const recentUserShiftsList = userShifts.slice(0, 3);
            
            for (const shift of recentUserShiftsList) {
                const item = document.createElement('div');
                item.className = 'p-3 bg-black/20 rounded-lg flex justify-between items-center mb-2';
                
                const actualDuration = shift.elapsed > 0 ? shift.elapsed * 60 : 0;
                
                item.innerHTML = `
                    <div>
                        <div class="flex items-center gap-2">
                            <span class="px-2 py-1 bg-[#F5FF82]/10 text-[#F5FF82] rounded-md text-xs font-medium">${shift.type || 'default'}</span>
                            <span class="text-sm text-gray-400">${shift.breaks || 0} breaks</span>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-sm font-semibold">${formatDuration(actualDuration)}</div>
                    </div>
                `;
                
                fragment.appendChild(item);
            }
            
            recentUserShifts.appendChild(fragment);
            
        } catch (error) {
            recentUserShifts.innerHTML = '<div class="empty-state"><i class="fas fa-exclamation-triangle"></i><p>Failed to load your shift history.</p></div>';
        }
    }

    async function loadERLCData(serverId) {
        if (!discordToken) {
            erlcServerInfo.innerHTML = '<div class="empty-state"><i class="fas fa-exclamation-triangle"></i><p>Authentication error. Please log in again.</p></div>';
            erlcPlayersList.innerHTML = '<div class="empty-state col-span-full"><i class="fas fa-exclamation-triangle"></i><p>Authentication error. Please log in again.</p></div>';
            return;
        }
        
        try {
            const response = await fetch(`https://api.duckybot.xyz/guilds/${serverId}/erlc/data`, {
                headers: { "Discord-Code": discordToken }
            });
            
            if (!response.ok) {
                throw new Error('Failed to fetch ER:LC data');
            }
            
            const data = await response.json();
            
            if (!data.data) {
                erlcServerInfo.innerHTML = '<div class="empty-state"><i class="fas fa-server"></i><p>No ER:LC server found.</p></div>';
                erlcPlayersList.innerHTML = '<div class="empty-state col-span-full"><i class="fas fa-users"></i><p>No players found.</p></div>';
                return;
            }
            
            const serverData = data.data.server;
            const isOnline = data.data.players.length > 0;
            
            erlcServerInfo.innerHTML = `
                <div>
                    <h4 class="text-lg font-semibold mb-4">Server Details</h4>
                    <div class="space-y-3">
                        <div class="server-info-item">
                            <div class="server-info-label">Server Name:</div>
                            <div class="server-info-value">${serverData.Name || 'Unknown'}</div>
                        </div>
                        <div class="server-info-item">
                            <div class="server-info-label">Players:</div>
                            <div class="server-info-value">${data.data.players.length || 0} / ${serverData.MaxPlayers || '?'}</div>
                        </div>
                        <div class="server-info-item">
                            <div class="server-info-label">Queue:</div>
                            <div class="server-info-value">${data.data.lastQueueCount || 0}</div>
                        </div>
                        <div class="server-info-item">
                            <div class="server-info-label">Join Key:</div>
                            <div class="server-info-value">
                                <a href="https://policeroleplay.community/join/${serverData.JoinKey}" class="text-white hover:underline">${serverData.JoinKey || 'None'}</a>
                            </div>
                        </div>
                        <div class="server-info-item">
                            <div class="server-info-label">Status:</div>
                            <div class="server-info-value">
                                <span class="status-badge ${isOnline ? 'online' : 'offline'}">${isOnline ? 'Online' : 'Offline'}</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            if (!data.data.players || data.data.players.length === 0) {
                erlcPlayersList.innerHTML = '<div class="empty-state col-span-full"><i class="fas fa-users"></i><p>No players found.</p></div>';
                return;
            }
            
            erlcPlayersList.innerHTML = '';
            
            const fragment = document.createDocumentFragment();
            
            const bolosResponse = await fetch(`https://api.duckybot.xyz/guilds/${serverId}/bolos`, {
                headers: { "Discord-Code": discordToken }
            }).catch(() => ({ ok: false }));
            
            let bolos = [];
            if (bolosResponse && bolosResponse.ok) {
                const bolosData = await bolosResponse.json();
                bolos = bolosData.data || [];
            }
            
            for (const player of data.data.players) {
                const playerCard = document.createElement('div');
                playerCard.className = 'p-3 bg-black/30 rounded-lg border-l-2 border-[#F5FF82]';
                
                const robloxUser = await fetchUserData(player.ID);
                const avatarUrl = robloxUser.avatar;
                
                const hasBOLO = bolos.some(bolo => bolo.user === player.ID);
                
                playerCard.innerHTML = `
                    <div class="flex items-start gap-3">
                        <div class="avatar-circle">
                            ${avatarUrl ? `<img src="${avatarUrl}" alt="${player.Name}">` : player.Name.charAt(0)}
                        </div>
                        <div class="flex-1">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h4 class="font-medium flex items-center gap-2">
                                        ${player.Name}
                                        ${hasBOLO ? '<span class="bolo-tag"><i class="fas fa-exclamation-triangle"></i>BOLO</span>' : ''}
                                    </h4>
                                    <p class="text-sm text-gray-400 mt-1">Team: ${player.Team || 'Civilian'}</p>
                                    <p class="text-sm text-gray-400">Permission: ${player.Permission || 'None'}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                fragment.appendChild(playerCard);
            }
            
            erlcPlayersList.appendChild(fragment);
            
        } catch (error) {
            erlcServerInfo.innerHTML = '<div class="empty-state"><i class="fas fa-exclamation-triangle"></i><p>Failed to load ER:LC data. Please try again.</p></div>';
            erlcPlayersList.innerHTML = '<div class="empty-state col-span-full"><i class="fas fa-exclamation-triangle"></i><p>Failed to load players. Please try again.</p></div>';
        }
    }    
    
    async function loadBOLOs(serverId) {
        if (!activeBOLOs) return;
        
        if (!discordToken) {
            activeBOLOs.innerHTML = '<div class="empty-state"><i class="fas fa-exclamation-triangle"></i><p>Authentication error. Please log in again.</p></div>';
            return;
        }
        
        try {
            const response = await fetch(`https://api.duckybot.xyz/guilds/${serverId}/bolos`, {
                headers: { "Discord-Code": discordToken }
            });
            
            if (!response.ok) {
                throw new Error('Failed to fetch BOLOs');
            }
            
            const data = await response.json();
            
            if (!data.data || data.data.length === 0) {
                activeBOLOs.innerHTML = '<div class="empty-state"><i class="fas fa-search"></i><p>No active BOLOs found.</p></div>';
                return;
            }
            
            activeBOLOs.innerHTML = '';
            
            const fragment = document.createDocumentFragment();
            
            for (const bolo of data.data) {
                const boloCard = document.createElement('div');
                boloCard.className = 'p-3 bg-black/30 rounded-lg border-l-2 border-red-500 mb-3';
                boloCard.dataset.robloxId = bolo.user;
                
                const robloxUser = await fetchUserData(bolo.user);
                const avatarUrl = robloxUser.avatar;
                
                boloCard.innerHTML = `
                    <div class="flex items-start gap-3">
                        <div class="avatar-circle">
                            ${avatarUrl ? `<img src="${avatarUrl}" alt="${robloxUser.name}">` : robloxUser.name.charAt(0)}
                        </div>
                        <div class="flex-1">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h4 class="font-medium">${robloxUser.name}</h4>
                                    <p class="text-sm text-gray-400 mt-1">${bolo.reason}</p>
                                    <p class="text-xs text-gray-500 mt-2">Created: ${formatDate(bolo.created)}</p>
                                </div>
                                <div class="flex gap-2">
                                    <button class="approve-bolo-btn px-2 py-1 bg-green-500/10 text-green-500 rounded-md text-xs font-medium hover:bg-green-500/20 transition">
                                        <i class="fas fa-check"></i>
                                    </button>
                                    <button class="delete-bolo-btn px-2 py-1 bg-red-500/10 text-red-500 rounded-md text-xs font-medium hover:bg-red-500/20 transition">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;                
                const approveBtn = boloCard.querySelector('.approve-bolo-btn');
                const deleteBtn = boloCard.querySelector('.delete-bolo-btn');
                
                approveBtn.addEventListener('click', () => approveBOLO(bolo.user));
                deleteBtn.addEventListener('click', () => deleteBOLO(bolo.user));
                
                fragment.appendChild(boloCard);
            }
            
            activeBOLOs.appendChild(fragment);
            
        } catch (error) {
            activeBOLOs.innerHTML = '<div class="empty-state"><i class="fas fa-exclamation-triangle"></i><p>Failed to load BOLOs. Please try again.</p></div>';
        }
    }
    
    async function createBOLO() {
        if (!discordToken || !selectedServerId) {
            showToast('Authentication error. Please log in again.', 'error');
            return;
        }
        
        const username = document.getElementById('boloUsername').value;
        const reason = document.getElementById('boloReason').value;
        
        if (!username || !reason) {
            showToast('Please fill in all fields', 'error');
            return;
        }
        
        const submitBtn = document.getElementById('submitBoloBtn');
        const originalBtnText = submitBtn.innerHTML;
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Processing...';
        
        try {
            const response = await fetch(`https://api.duckybot.xyz/guilds/${selectedServerId}/bolos`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Discord-Code': discordToken
                },
                body: JSON.stringify({
                    username: username,
                    reason: reason
                })
            });
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || 'Failed to create BOLO');
            }
            
            boloForm.reset();
            showToast(`Successfully created BOLO for ${username}`);
            
            loadBOLOs(selectedServerId);
            loadERLCData(selectedServerId);
            
        } catch (error) {
            showToast(error.message || 'Failed to create BOLO. Please try again.', 'error');
        } finally {
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalBtnText;
        }
    }
    
    async function approveBOLO(robloxId) {
        if (!discordToken || !selectedServerId) {
            showToast('Authentication error. Please log in again.', 'error');
            return;
        }
        
        try {
            const response = await fetch(`https://api.duckybot.xyz/guilds/${selectedServerId}/bolos/${robloxId}`, {
                method: 'POST',
                headers: {
                    'Discord-Code': discordToken
                }
            });
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || 'Failed to approve BOLO');
            }
            
            showToast('BOLO approved successfully');
            
            const boloCard = document.querySelector(`[data-roblox-id="${robloxId}"]`);
            if (boloCard) {
                boloCard.remove();
                
                if (activeBOLOs.children.length === 0) {
                    activeBOLOs.innerHTML = '<div class="empty-state"><i class="fas fa-search"></i><p>No active BOLOs found.</p></div>';
                }
            }
            
            loadERLCData(selectedServerId);
            
        } catch (error) {
            showToast(error.message || 'Failed to approve BOLO. Please try again.', 'error');
        }
    }
    
    async function deleteBOLO(robloxId) {
        if (!discordToken || !selectedServerId) {
            showToast('Authentication error. Please log in again.', 'error');
            return;
        }
        
        try {
            const response = await fetch(`https://api.duckybot.xyz/guilds/${selectedServerId}/bolos/${robloxId}`, {
                method: 'DELETE',
                headers: {
                    'Discord-Code': discordToken
                }
            });
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error('Failed to delete BOLO');
            }
            
            showToast('BOLO deleted successfully');
            
            const boloCard = document.querySelector(`[data-roblox-id="${robloxId}"]`);
            if (boloCard) {
                boloCard.remove();
                
                if (activeBOLOs.children.length === 0) {
                    activeBOLOs.innerHTML = '<div class="empty-state"><i class="fas fa-search"></i><p>No active BOLOs found.</p></div>';
                }
            }
            
            loadERLCData(selectedServerId);
            
        } catch (error) {
            showToast('Failed to delete BOLO. Please try again.', 'error');
        }
    }

    async function executeCommand() {
        if (!discordToken || !selectedServerId) {
            showToast('Authentication error. Please log in again.', 'error');
            return;
        }
        
        const commandInput = document.getElementById('command');
        const command = commandInput.value.trim();
        
        if (!command) {
            showToast('Please enter a command', 'error');
            return;
        }
        
        const executeBtn = document.getElementById('executeCommandBtn');
        const originalBtnText = executeBtn.innerHTML;
        executeBtn.disabled = true;
        executeBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Executing...';
        
        try {
            const response = await fetch(`https://api.duckybot.xyz/guilds/${selectedServerId}/erlc/execute`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Discord-Code': discordToken
                },
                body: JSON.stringify({
                    command: command
                })
            });
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || 'Failed to execute command');
            }
            
            commandInput.value = '';
            showToast(`Command executed successfully`);
            
        } catch (error) {
            showToast('Failed to execute command. Please try again.', 'error');
        } finally {
            executeBtn.disabled = false;
            executeBtn.innerHTML = originalBtnText;
        }
    }

    async function issuePunishment() {
        const now = Date.now();
        if (now - lastPunishmentTime < PUNISHMENT_COOLDOWN) {
            showToast('Please wait 5 seconds between punishments', 'error');
            return;
        }

        if (!discordToken) {
            showToast('Authentication error. Please log in again.', 'error');
            return;
        }
        
        const robloxUsername = document.getElementById('robloxUsername').value;
        const type = document.getElementById('punishmentType').value;
        const reason = document.getElementById('reason').value;
        
        if (!type) {
            showToast('Please select a punishment type', 'error');
            return;
        }
        
        let expires = null;
        if (type === 'tempban') {
            const durationValue = document.getElementById('durationValue').value;
            const durationUnit = document.getElementById('durationUnit').value;
            
            if (!durationValue || durationValue <= 0) {
                showToast('Please enter a valid duration', 'error');
                return;
            }
            
            const multipliers = {
                minutes: 60,
                hours: 3600,
                days: 86400,
                weeks: 604800
            };
            
            const duration = durationValue * multipliers[durationUnit];
            expires = Math.floor(Date.now() / 1000) + duration;
        }
        
        const submitBtn = document.getElementById('submitBtn');
        const originalBtnText = submitBtn.innerHTML;
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Processing...';
        
        try {
            const response = await fetch(`https://api.duckybot.xyz/guilds/${selectedServerId}/punishments`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Discord-Code': discordToken
                },
                body: JSON.stringify({
                    username: robloxUsername,
                    type,
                    reason,
                    expires
                })
            });
            
            const data = await response.json();
            
            if (!response.ok) {
                throw new Error(data.message || 'Failed to issue punishment');
            }
            
            punishmentForm.reset();
            durationContainer.classList.add('hidden');
            punishmentTypeSelected.querySelector('span').textContent = 'Select type...';
            document.querySelectorAll('#punishmentTypeOptions .dropdown-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            
            showToast(`Successfully issued ${type} to ${robloxUsername}`);
            lastPunishmentTime = now;
            
            loadPunishments(selectedServerId);
            
        } catch (error) {
            showToast(error.message || 'Failed to issue punishment. Please try again.', 'error');
        } finally {
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalBtnText;
        }
    }
    
    async function checkActiveShift(serverId) {
        if (!discordToken || !discordUser) return;
        
        try {
            const response = await fetch(`https://api.duckybot.xyz/guilds/${selectedServerId}/shifts`, {
                headers: { "Discord-Code": discordToken }
            });
            
            if (!response.ok) {
                throw new Error('Failed to check active shift');
            }
            
            const { data } = await response.json();
            
            const userId = discordUser.id;
            let userActiveShift = null;
            
            if (data.activeshifts && data.activeshifts.length > 0) {
                userActiveShift = data.activeshifts.find(shift => shift.user === userId && shift.type === shiftType.value);
            }
            
            if (userActiveShift) {
                currentUserShift = userActiveShift;
                shiftStatus = userActiveShift.paused ? 'paused' : 'active';
                shiftStartTime = userActiveShift.started;
                shiftElapsedTime = userActiveShift.elapsed || 0;
                
                updateShiftUI();
                
                if (shiftStatus === 'active') {
                    startShiftTimer();
                }
            } else {
                shiftStatus = 'inactive';
                updateShiftUI();
            }
            
        } catch (error) {
            showToast('Failed to check active shift status', 'error');
        }
    }
    
    function updateShiftUI() {
        if (shiftStatus === 'paused') {
            startShiftBtn.disabled = false;
            pauseShiftBtn.disabled = true;
            endShiftBtn.disabled = false;
            
            startShiftBtn.innerHTML = '<i class="fas fa-play"></i><span>Resume</span>';
        } else if (shiftStatus === 'active') {
            startShiftBtn.disabled = true;
            pauseShiftBtn.disabled = false;
            endShiftBtn.disabled = false;
            
            startShiftBtn.innerHTML = '<i class="fas fa-play"></i><span>Start</span>';
        } else {
            startShiftBtn.disabled = false;
            pauseShiftBtn.disabled = true;
            endShiftBtn.disabled = true;
            
            startShiftBtn.innerHTML = '<i class="fas fa-play"></i><span>Start</span>';
        }
        
        shiftStatusIndicator.className = `shift-status ${shiftStatus}`;
        const pulse = shiftStatusIndicator.querySelector('.pulse');
        pulse.className = `pulse ${shiftStatus}`;
        
        if (shiftStatus === 'active') {
            shiftStatusText.textContent = 'On Duty';
        } else if (shiftStatus === 'paused') {
            shiftStatusText.textContent = 'Paused';
        } else {
            shiftStatusText.textContent = 'Off Duty';
        }
        
        if (shiftStatus === 'inactive') {
            shiftTimer.textContent = '00:00:00';
        }
    }
    
    function startShiftTimer() {
        if (shiftTimerInterval) {
            clearInterval(shiftTimerInterval);
        }
        
        shiftTimerInterval = setInterval(() => {
            if (shiftStatus === 'active') {
                const now = Math.floor(Date.now() / 1000);
                const elapsed = now - shiftStartTime + shiftElapsedTime;
                shiftTimer.textContent = formatShiftTime(elapsed);
            }
        }, 1000);
    }
    
    async function startShift() {
        if (!discordToken || !selectedServerId) {
            showToast('Authentication error. Please log in again.', 'error');
            return;
        }
        
        const type = shiftType.value;
        
        try {
            startShiftBtn.disabled = true;
            startShiftBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            
            if (shiftStatus === 'paused' && currentUserShift) {
                const response = await fetch(`https://api.duckybot.xyz/guilds/${selectedServerId}/shifts/start`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Discord-Code': discordToken
                    },
                    body: JSON.stringify({ type })
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Failed to resume shift');
                }
                
                shiftStatus = 'active';
                startShiftTimer();
                
                showToast('Shift resumed successfully');
            } else {
                const response = await fetch(`https://api.duckybot.xyz/guilds/${selectedServerId}/shifts/start`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Discord-Code': discordToken
                    },
                    body: JSON.stringify({ type })
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Failed to start shift');
                }
                
                shiftStatus = 'active';
                shiftStartTime = Math.floor(Date.now() / 1000);
                shiftElapsedTime = 0;
                
                startShiftTimer();
                
                showToast('Shift started successfully');
            }
            
            updateShiftUI();
            loadShifts(selectedServerId);
            
        } catch (error) {
            showToast('Failed to start shift: ' + error.message, 'error');
        } finally {
            startShiftBtn.disabled = false;
            if (shiftStatus === 'paused') {
                startShiftBtn.innerHTML = '<i class="fas fa-play"></i><span>Resume</span>';
            } else {
                startShiftBtn.innerHTML = '<i class="fas fa-play"></i><span>Start</span>';
            }
        }
    }
    
    async function pauseShift() {
        if (!discordToken || !selectedServerId) {
            showToast('Authentication error. Please log in again.', 'error');
            return;
        }

        const type = shiftType.value;
        
        try {
            pauseShiftBtn.disabled = true;
            pauseShiftBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            
            const response = await fetch(`https://api.duckybot.xyz/guilds/${selectedServerId}/shifts/pause`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Discord-Code': discordToken
                },
                body: JSON.stringify({ type })
            });
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || 'Failed to pause shift');
            }
            
            if (shiftTimerInterval) {
                clearInterval(shiftTimerInterval);
                shiftTimerInterval = null;
            }
            
            shiftStatus = 'paused';
            updateShiftUI();
            
            showToast('Shift paused successfully');
            
            loadShifts(selectedServerId);
            
        } catch (error) {
            showToast('Failed to pause shift: ' + error.message, 'error');
        } finally {
            pauseShiftBtn.disabled = false;
            pauseShiftBtn.innerHTML = '<i class="fas fa-pause"></i><span>Pause</span>';
        }
    }
    
    async function endShift() {
        if (!discordToken || !selectedServerId) {
            showToast('Authentication error. Please log in again.', 'error');
            return;
        }

        const type = shiftType.value;
        
        try {
            endShiftBtn.disabled = true;
            endShiftBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            
            const response = await fetch(`https://api.duckybot.xyz/guilds/${selectedServerId}/shifts/end`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Discord-Code': discordToken
                },
                body: JSON.stringify({ type })
            });
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || 'Failed to end shift');
            }
            
            if (shiftTimerInterval) {
                clearInterval(shiftTimerInterval);
                shiftTimerInterval = null;
            }
            
            shiftStatus = 'inactive';
            shiftStartTime = 0;
            shiftElapsedTime = 0;
            currentUserShift = null;
            
            updateShiftUI();
            
            showToast('Shift ended successfully');
            
            loadShifts(selectedServerId);
            
        } catch (error) {
            showToast('Failed to end shift: ' + error.message, 'error');
        } finally {
            endShiftBtn.disabled = false;
            endShiftBtn.innerHTML = '<i class="fas fa-stop"></i><span>End</span>';
        }
    }

    async function runDiscordCheck() {
        if (!discordToken || !selectedServerId) {
            showToast('Authentication error. Please log in again.', 'error');
            return;
        }
        
        if (discordCheckCooldowns[selectedServerId] && discordCheckCooldowns[selectedServerId] > Date.now()) {
            showToast('Discord check is on cooldown. Please wait before trying again.', 'error');
            return;
        }
        
        try {
            runDiscordCheckBtn.disabled = true;
            runDiscordCheckBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Running check...';
        
            const response = await fetch(`https://api.duckybot.xyz/guilds/${selectedServerId}/erlc/check`, {
                headers: { "Discord-Code": discordToken }
            });
            
            if (!response.ok) {
                throw new Error('Failed to run Discord check');
            }
            
            const { data } = await response.json();
            
            discordCheckList.innerHTML = '';
            
            if (!data || data.length === 0) {
                discordCheckList.innerHTML = '<div class="empty-state col-span-full"><i class="fas fa-users"></i><p>No players found in-game.</p></div>';
            } else {
                const fragment = document.createDocumentFragment();
                
                for (const player of data) {
                    const item = document.createElement('div');
                    item.className = 'p-4 bg-black/30 rounded-lg border-l-2 border-[#F5FF82]';
                    
                    if (player.discord) {
                        item.innerHTML = `
                            <div class="flex items-start gap-3">
                                <div class="avatar-circle">
                                    ${player.roblox.avatar ? `<img src="${player.roblox.avatar}" alt="${player.roblox.name}">` : player.roblox.name.charAt(0)}
                                </div>
                                <div class="flex-1">
                                    <div class="flex justify-between items-start">
                                        <div>
                                            <h4 class="font-medium">${player.roblox.displayName || player.roblox.name} <span class="text-sm text-gray-400">(${player.roblox.name})</span></h4>
                                            <div class="flex items-center gap-2 mt-1">
                                                <span class="px-2 py-1 bg-green-500/10 text-green-500 rounded-md text-xs font-medium">Discord Linked</span>
                                                <span class="text-sm text-gray-400">@${player.discord.username}</span>
                                            </div>
                                            ${player.discord.vc ? `
                                                <div class="mt-2">
                                                    <span class="flex items-center gap-1 text-sm text-[#F5FF82]">
                                                        <i class="fas fa-headset"></i> ${player.discord.vc.name}
                                                    </span>
                                                </div>
                                            ` : ''}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    } else {
                        item.innerHTML = `
                            <div class="flex items-start gap-3">
                                <div class="avatar-circle">
                                    ${player.roblox.avatar ? `<img src="${player.roblox.avatar}" alt="${player.roblox.name}">` : player.roblox.name.charAt(0)}
                                </div>
                                <div class="flex-1">
                                    <div class="flex justify-between items-start">
                                        <div>
                                            <h4 class="font-medium">${player.roblox.displayName || player.roblox.name} <span class="text-sm text-gray-400">(${player.roblox.name})</span></h4>
                                            <div class="flex items-center gap-2 mt-1">
                                                <span class="px-2 py-1 bg-red-500/10 text-red-500 rounded-md text-xs font-medium">Not Linked</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                    
                    fragment.appendChild(item);
                }
                
                discordCheckList.appendChild(fragment);
            }
            
            discordCheckResults.classList.remove('hidden');
            
            discordCheckCooldowns[selectedServerId] = Date.now() + DISCORD_CHECK_COOLDOWN;
            updateDiscordCheckCooldown();
            
        } catch (error) {
            showToast('Failed to run Discord check: ' + error.message, 'error');
        } finally {
            if (!discordCheckCooldowns[selectedServerId] || discordCheckCooldowns[selectedServerId] <= Date.now()) {
                runDiscordCheckBtn.disabled = false;
                runDiscordCheckBtn.innerHTML = 'Run Discord Check';
            }
        }
    }

    runDiscordCheckBtn.addEventListener('click', runDiscordCheck);

    window.addEventListener('load', () => {
        initDropdowns();
        loadServers();
    });
    </script>
</body>
</html>