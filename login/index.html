<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login with Discord</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="welcome">
        <p>Give us a moment...</p>
    </div>
</body>
<script>
    window.onload = () => {
        const params = new URLSearchParams(window.location.search)
        function getCookie(name) {
            let value = `; ${document.cookie}`;
            let parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
        }
        const redirectAfter = params.get('redirect')
        const loggedin = getCookie('discord')
        if (loggedin) {
            fetch('https://discord.com/api/users/@me', {
                headers: {
                    authorization: `Bearer ${loggedin}`,
                },
            })
            .then(result => result.json())
            .then(response => {
                document.body.innerHTML = "Welcome, @" + response.username
                console.log(`You're logged in as @${response.username}.`)
            })
            .catch(console.error)

            if (redirectAfter) {
                window.location.href = `https://duckybot.xyz/${redirectAfter}`;
                console.log("Redirecting to https://duckybot.xyz/" + redirectAfter + "...");
            }
            return
        }
        const fragment = new URLSearchParams(window.location.hash.slice(1))
        const [accessToken, tokenType, state] = [fragment.get('access_token'), fragment.get('token_type'), fragment.get('state')]
        
        if (!accessToken) {
            if (redirectAfter) {
                window.location.href = "https://discord.com/oauth2/authorize?client_id=1257389588910182411&response_type=token&redirect_uri=https%3A%2F%2Fduckybot.xyz%2F&scope=identify&state=" + redirectAfter
            } else {
                window.location.href = "https://discord.com/oauth2/authorize?client_id=1257389588910182411&response_type=token&redirect_uri=https%3A%2F%2Fduckybot.xyz%2Flogin&scope=identify"
            }
            document.body.innerHTML = "You aren't logged in.<br><br>Redirecting you to Discord..."
            return
        }

        fetch('https://discord.com/api/users/@me', {
            headers: {
                authorization: `${tokenType} ${accessToken}`,
            },
        })
        .then(result => result.json())
        .then(response => {
            console.log(response)
            document.cookie = `discord=${accessToken}; path=/`
            console.log("Cookie saved.")
            document.body.innerHTML = "Welcome, @" + response.username
            if (redirectAfter) {
                window.location.href = "https://duckybot.xyz/" + redirectAfter
            }
        })
        .catch(console.error)
    }
</script>
</html>
